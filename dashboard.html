<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Dream Big — Dashboard</title>
<meta name="theme-color" content="#071a2a"/>
<style>
  /* ---------- Theme variables (base are light/white-blue) ---------- */
  :root{
    --bg:#f6f9fc;               /* light bg */
    --card:#ffffff;             /* card */
    --muted:#6b7d8c;            /* muted text */
    --accent:#1ea7ff;           /* primary blue accent */
    --accent-contrast:#042137;  /* text on accent */
    --danger:#e14b4b;
    --text:#042137;             /* primary text (dark) */
    --brand-radius:12px;
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  }

  /* navy/gold theme values (applied when theme === navy) */
  .theme-navy {
    --bg: linear-gradient(180deg,#021226 0%, #071a2a 100%);
    --card: linear-gradient(180deg,#072235,#0f2a44);
    --muted: #9fb3c7;
    --accent: #f6c44b;
    --accent-contrast: #042137;
    --danger: #e14b4b;
    --text: #eaf6ff;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
  .app{min-height:100vh;display:flex;flex-direction:column;padding:16px;gap:12px;transition:opacity .45s}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;z-index:50}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:var(--accent-contrast);font-weight:800;font-size:16px;overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:8px}
  .title{font-size:16px;font-weight:700}
  .meta{font-size:12px;color:var(--muted)}
  /* ensure hamburger sits above overlay so it's always clickable */
  .menu-btn{width:46px;height:46px;border-radius:12px;background:var(--card);display:flex;align-items:center;justify-content:center;border:none;color:var(--muted);font-weight:800;font-size:20px;position:relative;z-index:120}
  .overlay-dim{position:fixed;inset:0;background:rgba(0,0,0,0.45);opacity:0;pointer-events:none;transition:opacity 220ms ease;z-index:100}
  .overlay-dim.visible{opacity:1;pointer-events:auto}
  .menu-panel{position:fixed;top:72px;right:12px;width:92%;max-width:360px;background:var(--card);border-radius:14px;padding:10px;box-shadow:0 20px 60px rgba(0,0,0,0.08);transform-origin:top right;opacity:0;pointer-events:none;transform:translateY(-8px) scale(.98);transition:all 220ms cubic-bezier(.2,.9,.2,1);z-index:110;color:var(--text)}
  .menu-panel.open{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}
  .menu-item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;color:var(--muted);background:transparent;border:none;width:100%;text-align:left;font-weight:700;font-size:15px}
  .menu-item:hover{background:rgba(0,0,0,0.02);color:var(--text)}
  .menu-item .hint{font-size:12px;color:var(--muted);font-weight:600}
  /* profile circle removed visually - kept in DOM for backward compat but hidden */
  .profile{display:none}
  .profile img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .profile-initials{font-weight:800;color:var(--muted)}
  main{flex:1;overflow:auto;padding-bottom:110px}
  .welcome{background:var(--card);padding:14px;border-radius:16px;box-shadow:0 6px 18px rgba(2,6,20,0.04)}
  .writeup{margin-top:12px;color:var(--muted);line-height:1.45}
  .kpis{display:flex;gap:8px;margin-top:12px}
  .kpi{flex:1;padding:10px;background:rgba(0,0,0,0.02);border-radius:12px;text-align:left}
  .kpi .num{font-size:18px;font-weight:800}
  .card{background:var(--card);padding:14px;border-radius:16px;margin-top:14px}
  .form-row{display:flex;gap:8px;margin-top:12px}
  .input,select{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:transparent;color:var(--text);font-size:14px}
  .submit{background:var(--accent);color:var(--accent-contrast);padding:10px 14px;border-radius:10px;border:none;font-weight:700}
  /* progress bar */
  .progress-track { width:100%; background: rgba(0,0,0,0.06); height:14px; border-radius:999px; overflow:hidden; margin-top:10px; }
  .progress-fill { height:100%; width:0%; background:var(--accent); transition: width .6s cubic-bezier(.2,.9,.2,1), background .25s ease; box-shadow: 0 8px 30px rgba(0,0,0,0.08); border-radius:999px; }
  .progress-label { display:flex; justify-content:space-between; margin-top:8px; color:var(--muted); font-size:13px; }
  /* Footer: accent separator + simple copyright */
  footer{position:fixed;left:12px;right:12px;bottom:12px;background:var(--card);padding:12px;border-radius:12px;display:flex;align-items:center;box-shadow:0 8px 30px rgba(2,6,20,0.06);z-index:40;border-top:4px solid var(--accent);justify-content:center;color:var(--muted)}
  .btn{padding:10px 12px;border-radius:10px;border:none}
  .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(0,0,0,0.04)}
  .btn.warn{background:var(--danger);color:white}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:46}
  .modal{background:var(--card);padding:18px;border-radius:12px;min-width:280px;box-shadow:0 8px 30px rgba(0,0,0,0.08);position:relative;color:var(--text)}
  .modal h3{margin:0 0 6px 0;color:var(--text)}
  .modal p{color:var(--muted);margin:0 0 12px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end}
  .close-x{position:absolute;right:12px;top:10px;background:transparent;border:none;color:var(--danger);font-weight:900;font-size:20px;border-radius:6px;padding:6px}
  .proof-area{margin-top:12px;background:rgba(0,0,0,0.02);padding:12px;border-radius:10px}
  .file-preview{margin-top:8px;background:rgba(0,0,0,0.02);padding:8px;border-radius:8px}
  .profile-menu{position:absolute;top:62px;right:12px;background:var(--card);padding:8px;border-radius:10px;min-width:160px;display:none;box-shadow:0 8px 30px rgba(0,0,0,0.08);z-index:50}
  .profile-menu button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:none;background:transparent;color:var(--text);font-weight:700}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:110px;background:rgba(0,0,0,0.75);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:80;font-weight:700}
  .menu-header{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;margin-bottom:8px}
  .menu-header .hdr-name{font-weight:800}
  .small-pill{padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.02);font-weight:700;font-size:13px;color:var(--muted)}
  @media(min-width:540px){.app{padding:20px}}

  /* ---------- Typed banner styles (new) ---------- */
  .typed-banner { margin-top:10px; text-align:center; user-select:none; }
  .typed-banner .small-word { display:block; font-weight:900; font-size:12px; opacity:0.46; letter-spacing:1.4px; margin-bottom:6px; text-transform:uppercase; }
  .typed-banner .main-line { display:block; font-weight:900; font-size:20px; text-transform:uppercase; letter-spacing:0.8px; min-height:1.2em; }
  .typed-banner .banner-caret { display:inline-block; width:10px; height:1.05em; vertical-align:middle; background:var(--accent); margin-left:8px; border-radius:2px; animation: tb-blink 900ms steps(2,start) infinite; }
  @keyframes tb-blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }
  @media(min-width:900px){ .typed-banner .main-line { font-size:24px; } }
  @media(max-width:520px){ .typed-banner .main-line { font-size:16px; } }

  @media (prefers-reduced-motion: reduce) {
    .typed-banner .banner-caret { display:none !important; }
  }

</style>
</head>
<body>
  <div class="app" id="appRoot">

    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="logo" id="dbLogo">
          <!-- logo image inserted here if profile image saved -->
        </div>
        <div>
          <div class="title" id="dashboardTitle">Dashboard</div>
          <div class="meta" id="metaDate"></div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <!-- Hamburger moved to the top-right (profile circle hidden visually via CSS) -->
        <button class="menu-btn" id="menuBtn" aria-label="Open menu" aria-expanded="false">☰</button>

        <!-- profile circle kept in DOM for backwards compatibility but hidden -->
        <div class="profile" id="profileCircle" title="Profile">
          <img id="profileImg" alt="Profile" style="display:none">
          <span id="profileInitials" class="profile-initials">PD</span>

          <div class="profile-menu" id="profileMenu" role="menu" aria-hidden="true">
            <button id="viewProfileBtn">View Profile</button>
            <button id="editProfileBtn">Edit Profile</button>
            <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);margin:8px 0">
            <button id="profileLogoutBtn" style="color:var(--danger)">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <div class="overlay-dim" id="overlayDim" tabindex="-1"></div>

    <!-- MENU PANEL -->
    <div class="menu-panel" id="menuPanel" aria-hidden="true">
      <!-- new header: small profile + name + view/hide -->
      <div class="menu-header" id="menuHeader" style="background:transparent">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;overflow:hidden;background:var(--accent);display:grid;place-items:center" id="menuThumb">
            <!-- small thumb inserted -->
          </div>
          <div>
            <div class="hdr-name" id="menuName">Member Name</div>
            <div style="font-size:12px;color:var(--muted)" id="menuRole">Member</div>
          </div>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
          <button class="small-pill" id="menuViewToggle">Hide</button>
        </div>
      </div>

      <!-- Wallet added as first item -->
      <button class="menu-item" id="mWallet"><span>Wallet</span><span class="hint" id="walletHint">$0.00</span></button>

      <!-- Contribution and other items -->
      <button class="menu-item" id="mContribute"><span id="contribLabel">Contribution</span><span class="hint" id="contribHint">Contribution</span></button>
      <button class="menu-item" id="mViewProjects">View Projects<span class="hint">Your projects</span></button>
      <button class="menu-item" id="mWithdraw">Withdraw<span class="hint">Request</span></button>
      <button class="menu-item" id="mHelp">Help & Support<span class="hint">Contact</span></button>
      <div id="paymentsNavPlace"></div>
      <button class="menu-item" id="mSettings">Settings<span class="hint">Preferences</span></button>
      <button class="menu-item" id="mLogout">Logout<span class="hint">Sign out</span></button>
    </div>

    <main>
      <section class="welcome">
        <h2 id="welcomeTitle">Welcome, Member</h2>

        <!-- small write-up you asked for -->
        <p class="writeup">Dream Big Project helps individuals and communities move from an idea to funded, disciplined execution. Contribute, track your project, invite others and grow together.</p>

        <!-- NEW: Typed banner placed directly under welcome,
             will start typing once (after 3s) -->
        <div id="typedBanner" class="typed-banner" aria-live="polite" aria-atomic="true">
          <span class="small-word" id="typedSmall" aria-hidden="true"></span>
          <span class="main-line" id="typedMain" aria-hidden="true"></span>
          <span class="banner-caret" id="bannerCaret" aria-hidden="true" style="display:none"></span>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="num" id="activeProjectsCount">0</div><div style="font-size:12px;color:var(--muted)" id="kpiActiveLabel">Active Projects</div></div>
          <div class="kpi"><div class="num" id="totalContribution">$0</div><div style="font-size:12px;color:var(--muted)" id="kpiContributionLabel">Total Contribution</div></div>
          <div class="kpi"><div class="num" id="refersNum">0</div><div style="font-size:12px;color:var(--muted)" id="kpiReferralsLabel">Referrals</div></div>
        </div>
      </section>

      <article class="card">
        <div class="project-title">
          <div>
            <div style="font-weight:800" id="projectName">No project selected</div>
            <div style="font-size:12px;color:var(--muted)" id="projectMeta">No Dream Funding selected</div>
          </div>
          <div style="text-align:right;color:var(--muted)"><div style="font-weight:800" id="packageAmount"></div></div>
        </div>

        <!-- spaced paragraph(s) so bar can move below -->
        <div style="margin-top:18px;"></div>

        <!-- Dream Funding only (removed dot & contribution) -->
        <div id="dreamFunding" style="font-weight:800;color:var(--muted);margin-top:6px">Dream Funding: $0</div>

        <!-- Progress bar below dream funding -->
        <div class="progress-track" aria-hidden="true" id="progressTrack">
          <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
        <div class="progress-label">
          <div id="progressPct">0%</div>
          <div id="progressTarget">Target: —</div>
        </div>

      </article>

      <section class="card">
        <div style="font-weight:800" id="referralsTitle">Referrals</div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px" id="referralHint">Referrals are counted only after payments are approved by admin.</div>
        <div style="margin-top:10px"><button class="btn ghost" id="shareHere">Share Referral Link</button></div>
      </section>

    </main>

    <footer>
      <div style="font-size:13px">© 2026 Dream Big Project — All rights reserved.</div>
    </footer>

    <div class="toast" id="toast">Copied!</div>

    <!-- ========== MODALS ========== -->

    <!-- Wallet modal -->
    <div class="modal-backdrop" id="walletModal">
      <div class="modal" role="document">
        <button class="close-x" id="walletCloseX" title="Close">✕</button>
        <h3>Wallet</h3>
        <p style="color:var(--muted)">Quick view of your wallet balance and actions.</p>
        <div style="margin-top:12px;font-weight:800;font-size:20px" id="walletBalance">$0.00</div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="addFundsBtn">Add Funds</button>
          <button class="btn ghost" id="withdrawBtn">Withdraw</button>
        </div>
      </div>
    </div>

    <!-- Contribution modal -->
    <div class="modal-backdrop" id="contributeModal">
      <div class="modal" role="document">
        <button class="close-x" id="contribCloseX" title="Close">✕</button>
        <h3>Contribute</h3>
        <p>Choose a package, then select payment method (Bank or USDT TRC20). After payment, submit proof or paste TX hash.</p>
        <div style="margin-top:10px">
          <select class="input" id="packageSelect">
            <option value="">-- Select Package --</option>
            <option value="25">$25</option>
            <option value="50">$50</option>
            <option value="75">$75</option>
            <option value="100">$100</option>
            <option value="125">$125</option>
            <option value="150">$150</option>
            <option value="175">$175</option>
            <option value="200">$200</option>
            <option value="250">$250</option>
            <option value="300">$300</option>
            <option value="400">$400</option>
            <option value="500">$500</option>
            <option value="1000">$1000</option>
            <option value="5000">$5000</option>
            <option value="10000">$10000</option>
            <option value="50000">$50000</option>
            <option value="100000">$100000</option>
          </select>
        </div>
        <div style="margin-top:10px">
          <button class="btn ghost" id="methodBank">Bank Deposit</button>
          <button class="btn ghost" id="methodUSDT">USDT (TRC20)</button>
        </div>
        <div id="bankBlock" style="margin-top:12px;display:none">
          <div class="copy"><span class="label">Bank: FIRST NATIONAL BANK</span>
            <div>Account Name: DREAM BIG PROJECT</div>
            <div>Account Number: <strong id="bankAcct">0123456789</strong></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost copy-btn" data-copy="bankAcct">Copy Account</button>
          </div>
        </div>
        <div id="usdtBlock" style="margin-top:12px;display:none">
          <div class="copy"><span class="label">TRC20 Wallet (USDT)</span>
            <div id="walletAddr" style="word-break:break-all"><strong>TXxExampleWalletAddress1234567890abcdef</strong></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost copy-btn" data-copy="walletAddr">Copy Wallet</button>
            <button class="btn ghost" id="showQR">Show QR</button>
          </div>
        </div>
        <div style="margin-top:12px">
          <button class="btn" id="iPaidBtn">I have paid</button>
        </div>
        <div class="proof-area" id="proofArea" style="display:none">
          <button class="close-x" id="proofCloseX" title="Close">✕</button>
          <div style="font-weight:800" id="proofTitle">Upload proof or paste TX hash</div>
          <div style="font-size:13px;color:var(--muted);margin-top:6px" id="proofHint">Bank: upload image/PDF. USDT: paste transaction hash.</div>
          <div id="bankProofInputs" style="margin-top:8px;display:none">
            <div style="display:flex;gap:8px;align-items:center">
              <input type="file" id="proofFile" accept="image/*,.pdf">
              <button class="btn ghost" id="previewProof">Preview</button>
            </div>
            <div class="file-preview" id="filePreview" style="display:none;position:relative">
              <button class="close-x" id="previewCloseX" title="Close">✕</button>
              <div id="filePreviewInner"></div>
            </div>
          </div>
          <div id="usdtHashInput" style="margin-top:8px;display:none">
            <input class="input" id="txHash" placeholder="Paste transaction hash here">
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">Be sure the TX is confirmed on TRON network.</div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="cancelProof">Cancel</button>
            <button class="btn" id="submitProof">Submit</button>
          </div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button class="btn ghost" id="contribClose">Close</button>
        </div>
      </div>
    </div>

    <!-- Edit Profile modal (kept but profile circle hidden) -->
    <div class="modal-backdrop" id="editProfileModal">
      <div class="modal">
        <button class="close-x" id="editCloseX">✕</button>
        <h3>Edit Profile</h3>
        <p style="color:var(--muted)">Upload a facial image and change name or password. (Email is not editable here.)</p>
        <div style="margin-top:8px">
          <input type="file" id="profileImageFile" accept="image/*">
        </div>
        <div style="margin-top:10px">
          <div id="profilePreview" style="width:120px;height:120px;border-radius:8px;overflow:hidden;background:rgba(0,0,0,0.02);display:grid;place-items:center">No image</div>
        </div>
        <div style="margin-top:10px">
          <input class="input" id="editName" placeholder="Full name" type="text">
        </div>
        <div style="margin-top:10px">
          <input class="input" id="newPassword" placeholder="New password" type="password">
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn ghost" id="editCancel">Cancel</button>
          <button class="btn" id="saveProfileBtn">Save</button>
        </div>
      </div>
    </div>

    <!-- Settings modal (NEW) -->
    <div class="modal-backdrop" id="settingsModal">
      <div class="modal">
        <button class="close-x" id="settingsCloseX">✕</button>
        <h3>Settings</h3>
        <p style="color:var(--muted)">Manage profile image, name, password, 2FA, language and theme.</p>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
          <div style="width:80px;height:80px;border-radius:10px;overflow:hidden;background:rgba(0,0,0,0.02);display:grid;place-items:center" id="settingsPreview">No image</div>
          <div style="flex:1">
            <input class="input" id="settingsName" placeholder="Full name">
            <div style="margin-top:8px;display:flex;gap:8px">
              <input class="input" id="settingsPassword" placeholder="New password" type="password">
              <button class="btn ghost" id="settingsUploadBtn">Choose Image</button>
            </div>
            <input type="file" id="settingsImageFile" accept="image/*" style="display:none">
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label style="font-weight:700;font-size:13px">Two-Factor Authentication</label>
            <div style="font-size:13px;color:var(--muted)">Enable or disable 2FA for extra account security.</div>
          </div>
          <div>
            <button class="btn ghost" id="toggle2faBtn">Connect 2FA</button>
          </div>
        </div>
        <div id="twoFaArea" style="margin-top:8px;display:none">
          <div style="font-size:13px;color:var(--muted)">Scan this code in your authenticator app (demo), or copy secret:</div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div id="twoFaQRCode" style="width:120px;height:120px;border-radius:8px;overflow:hidden;background:#fff;display:grid;place-items:center"></div>
            <div>
              <div id="twoFaSecret" style="font-weight:800"></div>
              <div style="margin-top:8px"><button class="btn ghost" id="copy2faSecret">Copy</button></div>
            </div>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label style="font-weight:700;font-size:13px">Language</label>
            <select class="input" id="langSelect" style="margin-top:6px">
              <option value="en">English</option>
              <option value="fr">Français</option>
            </select>
          </div>
          <div style="flex:1">
            <label style="font-weight:700;font-size:13px">Theme</label>
            <select class="input" id="themeSelect" style="margin-top:6px">
              <option value="light">Light (white & blue)</option>
              <option value="navy">Navy & gold</option>
            </select>
          </div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button class="btn ghost" id="settingsCancel">Cancel</button>
          <button class="btn" id="settingsSave">Save Settings</button>
        </div>
      </div>
    </div>

    <!-- Payments modal (unchanged) -->
    <div class="modal-backdrop" id="paymentsModal">
      <div class="modal">
        <button class="close-x" id="paymentsCloseX">✕</button>
        <h3 id="paymentsTitle">Payments</h3>
        <div id="paymentsListArea" style="margin-top:10px"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="paymentsClose">Close</button></div>
      </div>
    </div>

    <!-- Projects modal (unchanged) -->
    <div class="modal-backdrop" id="projectsModal">
      <div class="modal">
        <button class="close-x" id="projectsCloseX">✕</button>
        <h3>Your Projects</h3>
        <div class="projects-list" id="projectsList" style="margin-top:10px"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="projectsClose">Close</button></div>
      </div>
    </div>

    <!-- Simple logout confirm modal (unchanged) -->
    <div class="modal-backdrop" id="logoutModal">
      <div class="modal">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to log out?</p>
        <div class="actions">
          <button class="btn ghost" id="btnNo">No</button>
          <button class="btn warn" id="btnYes">Yes</button>
        </div>
      </div>
    </div>

    <!-- QR modal (unchanged) -->
    <div class="modal-backdrop" id="qrModal">
      <div class="modal" style="text-align:center">
        <button class="close-x" id="qrCloseX">✕</button>
        <h3>USDT (TRC20) QR</h3>
        <div id="qrImage" style="margin:12px auto;width:220px;height:220px;border-radius:12px;overflow:hidden;background:#fff;display:grid;place-items:center"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="qrClose">Close</button></div>
      </div>
    </div>

  </div>

<script>
/* ---------- Utilities ---------- */
function numberWithCommas(x){
  if(x === undefined || x === null) return '';
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
const getById = id => document.getElementById(id);

/* ---------- Refs ---------- */
const menuBtn = getById('menuBtn');
const menuPanel = getById('menuPanel');
const overlayDim = getById('overlayDim');
const mWallet = getById('mWallet');
const mContribute = getById('mContribute');
const mViewProjects = getById('mViewProjects');
const mHelp = getById('mHelp');
const mSettings = getById('mSettings');
const mLogout = getById('mLogout');
const mWithdraw = getById('mWithdraw');
const paymentsNavPlace = getById('paymentsNavPlace');

const walletModal = getById('walletModal');
const walletCloseX = getById('walletCloseX');
const walletBalance = getById('walletBalance');
const addFundsBtn = getById('addFundsBtn');
const withdrawBtn = getById('withdrawBtn');

const profileCircle = getById('profileCircle');
const profileImg = getById('profileImg');
const profileInitials = getById('profileInitials');
const profileMenu = getById('profileMenu');
const viewProfileBtn = getById('viewProfileBtn');
const editProfileBtn = getById('editProfileBtn');
const profileLogoutBtn = getById('profileLogoutBtn');

const contributeModal = getById('contributeModal');
const contribClose = getById('contribClose');
const contribCloseX = getById('contribCloseX');
const methodBankBtn = getById('methodBank');
const methodUSDTBtn = getById('methodUSDT');
const bankBlock = getById('bankBlock');
const usdtBlock = getById('usdtBlock');
const iPaidBtn = getById('iPaidBtn');
const proofArea = getById('proofArea');
const proofCloseX = getById('proofCloseX');
const bankProofInputs = getById('bankProofInputs');
const usdtHashInput = getById('usdtHashInput');
const proofFile = getById('proofFile');
const previewProofBtn = getById('previewProof');
const filePreview = getById('filePreview');
const filePreviewInner = getById('filePreviewInner');
const previewCloseX = getById('previewCloseX');
const cancelProof = getById('cancelProof');
const submitProof = getById('submitProof');
const txHash = getById('txHash');

const packageSelect = getById('packageSelect');
const packageAmount = getById('packageAmount');
const projectName = getById('projectName');
const projectMeta = getById('projectMeta');
const progressPct = getById('progressPct');
const progressTarget = getById('progressTarget');
const progressFill = getById('progressFill');
const dreamFunding = getById('dreamFunding');

const editProfileModal = getById('editProfileModal');
const profileImageFile = getById('profileImageFile');
const profilePreview = getById('profilePreview');
const editName = getById('editName');
const newPassword = getById('newPassword');
const saveProfileBtn = getById('saveProfileBtn');
const editCancel = getById('editCancel');
const editCloseX = getById('editCloseX');

const settingsModal = getById('settingsModal');
const settingsCloseX = getById('settingsCloseX');
const settingsName = getById('settingsName');
const settingsPassword = getById('settingsPassword');
const settingsUploadBtn = getById('settingsUploadBtn');
const settingsImageFile = getById('settingsImageFile');
const settingsPreview = getById('settingsPreview');
const toggle2faBtn = getById('toggle2faBtn');
const twoFaArea = getById('twoFaArea');
const twoFaQRCode = getById('twoFaQRCode');
const twoFaSecret = getById('twoFaSecret');
const copy2faSecret = getById('copy2faSecret');
const langSelect = getById('langSelect');
const themeSelect = getById('themeSelect');
const settingsCancel = getById('settingsCancel');
const settingsSave = getById('settingsSave');

const paymentsModal = getById('paymentsModal');
const paymentsListArea = getById('paymentsListArea');
const paymentsClose = getById('paymentsClose');
const paymentsCloseX = getById('paymentsCloseX');

const projectsModal = getById('projectsModal');
const projectsList = getById('projectsList');
const projectsClose = getById('projectsClose');
const projectsCloseX = getById('projectsCloseX');

const logoutModal = getById('logoutModal');
const btnNo = getById('btnNo'), btnYes = getById('btnYes');

const qrModal = getById('qrModal'), qrImage = getById('qrImage'), qrClose = getById('qrClose'), qrCloseX = getById('qrCloseX');

const dbLogo = getById('dbLogo');
const toast = getById('toast');
const copyButtons = document.querySelectorAll('.copy-btn');
const shareHere = getById('shareHere');

const menuHeader = getById('menuHeader');
const menuThumb = getById('menuThumb');
const menuName = getById('menuName');
const menuViewToggle = getById('menuViewToggle');

let payments = JSON.parse(localStorage.getItem('payments') || '[]');
let projects = JSON.parse(localStorage.getItem('projects') || '[]');

/* ---------- Translations (small demo) ---------- */
const translations = { en: { dashboard: 'Dashboard', activeProjects: 'Active Projects', totalContribution: 'Total Contribution', referrals: 'Referrals', referralsHint: 'Referrals are counted only after payments are approved by admin.', contribution: 'Contribution', welcome: 'Welcome, ', shareText: 'Join me on Dream Big', settings: 'Settings', save: 'Save', cancel: 'Cancel', referralsTitle: 'Referrals' }, fr: { dashboard: 'Tableau de bord', activeProjects: 'Projets actifs', totalContribution: 'Contribution totale', referrals: 'Parrainages', referralsHint: 'Les parrainages sont comptés après approbation des paiements par l\\'admin.', contribution: 'Contribution', welcome: 'Bienvenue, ', shareText: 'Rejoignez-moi sur Dream Big', settings: 'Paramètres', save: 'Enregistrer', cancel: 'Annuler', referralsTitle: 'Parrainages' } };

/* ---------- Utilities ---------- */
function showToast(msg){ if(!toast) return; toast.innerText = msg || 'Copied!'; toast.style.display='block'; toast.style.opacity='1'; setTimeout(()=>{ toast.style.transition='opacity 300ms ease'; toast.style.opacity='0'; setTimeout(()=>{ toast.style.display='none'; toast.style.transition=''; },300); },1400); }
function copyText(text){ if(!text) return showToast('Nothing to copy'); if(navigator.clipboard){ navigator.clipboard.writeText(text).then(()=> showToast('Copied')); } else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showToast('Copied'); } catch(e){ showToast('Copy failed'); } ta.remove(); } }
function openModal(el){ if(!el) return; el.style.display='flex'; el.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function closeModal(el){ if(!el) return; el.style.display='none'; el.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

/* ---------- Robust Menu Toggle (reliable on mobile & desktop) ---------- */
let _docClickHandler = null;
function isMenuOpen(){ return menuPanel && menuPanel.classList.contains('open'); }
function openMenu(){
  if(!menuPanel || !overlayDim) return;
  menuPanel.classList.add('open');
  overlayDim.classList.add('visible');
  menuPanel.setAttribute('aria-hidden','false');
  menuBtn && menuBtn.setAttribute('aria-expanded','true');

  // add single document click handler to close when user clicks outside
  _docClickHandler = function(ev){
    if(menuPanel.contains(ev.target) || menuBtn.contains(ev.target)) return;
    closeMenu();
  };
  document.addEventListener('click', _docClickHandler, { capture: true });
  document.addEventListener('keyup', _onEscape);
}
function closeMenu(){
  if(!menuPanel || !overlayDim) return;
  menuPanel.classList.remove('open');
  overlayDim.classList.remove('visible');
  menuPanel.setAttribute('aria-hidden','true');
  menuBtn && menuBtn.setAttribute('aria-expanded','false');

  if(_docClickHandler) document.removeEventListener('click', _docClickHandler, { capture: true });
  _docClickHandler = null;
  document.removeEventListener('keyup', _onEscape);
}
function toggleMenu(e){
  if(e) e.stopPropagation();
  if(isMenuOpen()) closeMenu(); else openMenu();
}
function _onEscape(e){ if(e.key === 'Escape') closeMenu(); }

menuBtn && menuBtn.addEventListener('click', toggleMenu);
overlayDim && overlayDim.addEventListener('click', closeMenu);
menuPanel && menuPanel.addEventListener('click', (ev)=> ev.stopPropagation());

/* ---------- Wallet Nav behavior ---------- */
if(mWallet){
  mWallet.addEventListener('click', ()=> {
    closeMenu();
    // load quick wallet balance from localStorage (demo)
    const bal = Number(localStorage.getItem('walletBalance') || '0');
    walletBalance && (walletBalance.innerText = '$' + numberWithCommas(bal.toFixed(2) || '0.00'));
    openModal(walletModal);
  });
}
walletCloseX && walletCloseX.addEventListener('click', ()=> closeModal(walletModal));
addFundsBtn && addFundsBtn.addEventListener('click', ()=>{
  closeModal(walletModal);
  closeMenu();
  // open contribute modal as quick path to add funds
  openModal(contributeModal);
});
withdrawBtn && withdrawBtn.addEventListener('click', ()=>{
  closeModal(walletModal);
  // go to withdraw page or open withdraw flow (demo)
  window.location.href = 'withdraw.html';
});

/* ---------- Profile menu (safe guards) ---------- */
if(profileCircle){
  profileCircle.addEventListener('click',(e)=>{
    e.stopPropagation();
    const open = profileMenu.style.display === 'block';
    profileMenu.style.display = open ? 'none' : 'block';
    profileMenu.setAttribute('aria-hidden', open ? 'true' : 'false');
  });
}
document.addEventListener('click',(e)=>{
  if(profileMenu && profileMenu.style.display === 'block' && profileCircle && !profileCircle.contains(e.target)){
    profileMenu.style.display='none'; profileMenu.setAttribute('aria-hidden','true');
  }
});
if(viewProfileBtn) viewProfileBtn.addEventListener('click', ()=>{ if(profileMenu) profileMenu.style.display='none'; alert('Profile view (demo)'); });
if(editProfileBtn) editProfileBtn.addEventListener('click', ()=>{ if(profileMenu) profileMenu.style.display='none'; openModal(editProfileModal); });
if(profileLogoutBtn) profileLogoutBtn.addEventListener('click', ()=>{ if(profileMenu) profileMenu.style.display='none'; openModal(logoutModal); });

/* ---------- Init user & profile image (safe) ---------- */
function safeSetProfileImage(dataUrl){
  if(!dataUrl) return;
  if(profileImg){ profileImg.src = dataUrl; profileImg.style.display = 'block'; }
  if(profileInitials) profileInitials.style.display = 'none';
  if(dbLogo) dbLogo.innerHTML = '<img src="'+dataUrl+'" alt="logo">';
  if(menuThumb) menuThumb.innerHTML = '<img src="'+dataUrl+'" style="width:100%;height:100%;object-fit:cover">';
  localStorage.setItem('profileImage', dataUrl);
}
function setInitialsFromName(name){
  const parts = (name||'').trim().split(' ');
  let initials = 'PD';
  if(parts.length>0 && parts[0].length>0) initials = parts[0][0].toUpperCase() + (parts[1]? parts[1][0].toUpperCase() : '');
  if(profileInitials) profileInitials.innerText = initials;
  if(!localStorage.getItem('profileImage') && menuThumb) menuThumb.innerText = initials;
}
function loadUser(){
  let user = JSON.parse(localStorage.getItem('user') || 'null');
  if(!user || !user.name){
    const name = prompt('Enter your name to continue (demo login):') || 'Member';
    const password = prompt('Choose a password (demo):') || '';
    user = { name, password };
    localStorage.setItem('user', JSON.stringify(user));
  }
  const welcomeEl = getById('welcomeTitle');
  if(welcomeEl) welcomeEl.innerText = translations[getLang()].welcome + user.name;
  if(editName) editName.value = user.name || '';
  if(settingsName) settingsName.value = user.name || '';
  setInitialsFromName(user.name);
  const savedImg = localStorage.getItem('profileImage');
  if(savedImg) safeSetProfileImage(savedImg);
  if(menuName) menuName.innerText = user.name;
}
loadUser();

/* ---------- Contribution modal & flows ---------- */
let preferredMethod = localStorage.getItem('preferredContribution') || 'bank';
function showBank(){ if(bankBlock) bankBlock.style.display='block'; if(usdtBlock) usdtBlock.style.display='none'; preferredMethod='bank'; localStorage.setItem('preferredContribution','bank'); if(getById('contribHint')) getById('contribHint').innerText='Bank Deposit'; }
function showUSDT(){ if(bankBlock) bankBlock.style.display='none'; if(usdtBlock) usdtBlock.style.display='block'; preferredMethod='usdt'; localStorage.setItem('preferredContribution','usdt'); if(getById('contribHint')) getById('contribHint').innerText='USDT (TRC20)'; }
if(methodBankBtn) methodBankBtn.addEventListener('click', showBank);
if(methodUSDTBtn) methodUSDTBtn.addEventListener('click', showUSDT);

if(mContribute) mContribute.addEventListener('click', ()=>{ closeMenu(); openModal(contributeModal); const pref = localStorage.getItem('preferredContribution') || 'bank'; if(pref==='usdt') showUSDT(); else showBank(); });

if(contribClose) contribClose.addEventListener('click', ()=> closeModal(contributeModal));
if(contribCloseX) contribCloseX.addEventListener('click', ()=> closeModal(contributeModal));

/* progress helper */
function updateProgress(percent){
  const p = Math.max(0, Math.min(100, Math.round(percent)));
  if(progressFill) progressFill.style.width = p + '%';
  if(progressPct) progressPct.innerText = p + '%';
  let color = '#e14b4b';
  if(p <= 40) color = '#e14b4b';
  else if(p <= 60) color = '#f6c44b';
  else color = '#34d399';
  if(progressFill) progressFill.style.background = color;
}

/* package selection */
if(packageSelect) packageSelect.addEventListener('change', ()=>{
  const val = packageSelect.value;
  if(!val){
    if(packageAmount) packageAmount.innerText='';
    if(projectName) projectName.innerText='No project selected';
    if(projectMeta) projectMeta.innerText='Choose a package from Contribution';
    if(dreamFunding) dreamFunding.innerText = 'Dream Funding: $0';
    localStorage.removeItem('selectedPackage');
    updateProgress(0);
    if(progressTarget) progressTarget.innerText = 'Target: —';
    return;
  }
  const price = Number(val);
  const pkg = { name: '$' + price, price: price, funding: price * 100 };
  localStorage.setItem('selectedPackage', JSON.stringify(pkg));
  if(projectName) projectName.innerText = pkg.name + ' Package';
  if(projectMeta) projectMeta.innerText = pkg.name + ' • Package selected';
  if(packageAmount) packageAmount.innerText = '(' + pkg.name + ' Contribution)';
  if(dreamFunding) dreamFunding.innerText = 'Dream Funding: $' + numberWithCommas(pkg.funding);
  updateProgress(0);
  if(progressTarget) progressTarget.innerText = 'Target: $' + numberWithCommas(pkg.funding);
});

/* I have paid flow */
if(iPaidBtn) iPaidBtn.addEventListener('click', ()=>{
  if(proofArea) proofArea.style.display='block';
  const pref = localStorage.getItem('preferredContribution') || preferredMethod || 'bank';
  if(pref === 'usdt'){ if(bankProofInputs) bankProofInputs.style.display='none'; if(usdtHashInput) usdtHashInput.style.display='block'; }
  else { if(bankProofInputs) bankProofInputs.style.display='flex'; if(usdtHashInput) usdtHashInput.style.display='none'; }
});
if(proofCloseX) proofCloseX.addEventListener('click', ()=> { if(proofArea) proofArea.style.display='none'; });
if(cancelProof) cancelProof.addEventListener('click', ()=> { if(proofArea) proofArea.style.display='none'; });

/* preview proof */
if(previewProofBtn){
  previewProofBtn.addEventListener('click', ()=>{
    const f = proofFile && proofFile.files && proofFile.files[0];
    if(!f) return showToast('Choose a file first');
    if(filePreview) filePreview.style.display='block';
    if(f.type && f.type.startsWith && f.type.startsWith('image/')){
      const r = new FileReader();
      r.onload = e => { if(filePreviewInner) filePreviewInner.innerHTML = '<img src="'+e.target.result+'" style="max-width:100%;border-radius:8px">'; };
      r.readAsDataURL(f);
    } else {
      if(filePreviewInner) filePreviewInner.innerHTML = '<div style="padding:8px;color:var(--muted)">'+f.name+'</div>';
    }
  });
}
if(previewCloseX) previewCloseX.addEventListener('click', ()=> { if(filePreview) filePreview.style.display='none'; if(filePreviewInner) filePreviewInner.innerHTML=''; });

/* submit proof */
if(submitProof){
  submitProof.addEventListener('click', ()=>{
    const pkg = JSON.parse(localStorage.getItem('selectedPackage') || 'null');
    if(!pkg) return showToast('Choose a package first');
    const pref = localStorage.getItem('preferredContribution') || preferredMethod || 'bank';
    const record = { id: 'PAY-'+Date.now(), package: pkg, method: pref, date: new Date().toISOString(), status: 'pending' };
    if(pref === 'usdt'){
      const hash = txHash && txHash.value && txHash.value.trim();
      if(!hash) return showToast('Paste transaction hash first');
      record.hash = hash;
    } else {
      const f = proofFile && proofFile.files && proofFile.files[0];
      if(!f) return showToast('Upload proof file first');
      record.proofFilename = f.name;
    }
    payments.push(record);
    localStorage.setItem('payments', JSON.stringify(payments));
    // show confirmation inside modal (demo)
    const modal = contributeModal && contributeModal.querySelector('.modal');
    if(modal){
      modal.innerHTML = '<button class="close-x" id="contribCloseConfirm">✕</button><h3>Congratulations (Pending Approval)</h3><p style="color:var(--muted)">Please be patient while we review your payment within 48 hours.</p><div style="margin-top:12px"><button class="btn" id="backToDashboard">Back to dashboard</button></div>';
      setTimeout(()=>{
        const back = getById('backToDashboard');
        const closeConfirm = getById('contribCloseConfirm');
        if(back) back.addEventListener('click', ()=> location.reload());
        if(closeConfirm) closeConfirm.addEventListener('click', ()=> location.reload());
      },80);
    }
    if(proofArea) proofArea.style.display='none';
    if(filePreview) filePreview.style.display='none';
    if(filePreviewInner) filePreviewInner.innerHTML='';
    if(proofFile) proofFile.value='';
    if(txHash) txHash.value='';
    refreshPaymentsNav();
  });
}

/* refresh payments nav */
function refreshPaymentsNav(){
  payments = JSON.parse(localStorage.getItem('payments') || '[]');
  if(paymentsNavPlace) paymentsNavPlace.innerHTML = '';
  if(payments.length>0 && paymentsNavPlace){
    const unCount = payments.filter(p=>p.status==='pending').length;
    const apCount = payments.filter(p=>p.status==='approved').length;
    const btnUn = document.createElement('button'); btnUn.className='menu-item'; btnUn.innerHTML='<span>Unapproved Payments</span><span class="hint">'+unCount+'</span>';
    btnUn.addEventListener('click', ()=> { closeMenu(); openPaymentsList('pending'); });
    const btnAp = document.createElement('button'); btnAp.className='menu-item'; btnAp.innerHTML='<span>Approved Payments</span><span class="hint">'+apCount+'</span>';
    btnAp.addEventListener('click', ()=> { closeMenu(); openPaymentsList('approved'); });
    paymentsNavPlace.appendChild(btnUn); paymentsNavPlace.appendChild(btnAp);
  }
}

/* open payments list modal */
function openPaymentsList(status){
  payments = JSON.parse(localStorage.getItem('payments') || '[]');
  if(!paymentsListArea) return;
  paymentsListArea.innerHTML = '';
  const list = payments.filter(p=>p.status===status);
  if(list.length===0){ paymentsListArea.innerHTML = '<div style="color:var(--muted)">No payments '+status+'</div>'; openModal(paymentsModal); return; }
  list.forEach(p=>{
    const d = document.createElement('div'); d.style.padding='10px'; d.style.background='rgba(0,0,0,0.02)'; d.style.borderRadius='8px'; d.style.marginTop='8px';
    d.innerHTML = '<div style="font-weight:800">'+p.package.name+' • $'+p.package.price+'</div><div style="font-size:13px;color:var(--muted)">' + 'Dream Funding: $' + numberWithCommas(p.package.funding) + ' • ' + (p.method==='usdt'?'USDT':'Bank')+' • '+new Date(p.date).toLocaleString() + '</div>';
    if(p.status==='pending'){
      const stat = document.createElement('div'); stat.style.marginTop='8px'; stat.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--danger);margin-right:8px"></span><span>Yet to be approved</span>';
      d.appendChild(stat);
      const simWrap = document.createElement('div'); simWrap.style.marginTop='8px';
      const approveBtn = document.createElement('button'); approveBtn.className='btn'; approveBtn.innerText='Simulate Approve (Demo)';
      approveBtn.addEventListener('click', ()=>{
        p.status='approved';
        payments = payments.map(x=> x.id===p.id? p : x);
        localStorage.setItem('payments', JSON.stringify(payments));
        projects.push({ id:'PRJ-'+Date.now(), name:p.package.name, amount:p.package.price, funding: p.package.funding, status:'Active' });
        localStorage.setItem('projects', JSON.stringify(projects));
        const refs = parseInt(localStorage.getItem('referrals')||'0',10) + 1;
        localStorage.setItem('referrals', refs.toString());
        refreshPaymentsNav(); renderProjects(); updateReferralsUI();
        showToast('Payment approved (demo).');
        openPaymentsList('approved');
      });
      simWrap.appendChild(approveBtn); d.appendChild(simWrap);
    } else {
      const stat = document.createElement('div'); stat.style.marginTop='8px'; stat.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#34d399;box-shadow:0 0 6px rgba(52,211,153,0.35);margin-right:8px"></span><span>Approved and active</span>';
      d.appendChild(stat);
      const viewBtn = document.createElement('button'); viewBtn.className='btn ghost'; viewBtn.style.marginTop='8px'; viewBtn.innerText='View in Projects';
      viewBtn.addEventListener('click', ()=> { closeModal(paymentsModal); renderProjects(); openModal(projectsModal); });
      d.appendChild(viewBtn);
    }
    paymentsListArea.appendChild(d);
  });
  openModal(paymentsModal);
}

/* ---------- Projects ---------- */
function renderProjects(){
  projects = JSON.parse(localStorage.getItem('projects') || '[]');
  if(!projectsList) return;
  projectsList.innerHTML = '';
  if(!projects || projects.length===0){ projectsList.innerHTML = '<div style="color:var(--muted)">No projects yet.</div>'; if(getById('activeProjectsCount')) getById('activeProjectsCount').innerText = 0; return; }
  projects.forEach(p=>{
    const div = document.createElement('div');
    div.className='project-item';
    div.style.marginTop='8px';
    div.style.padding='10px';
    div.style.background='rgba(0,0,0,0.02)';
    div.innerHTML = '<div style="font-weight:800">'+p.name+'</div><div style="font-size:13px;color:var(--muted)">ID: '+p.id+' • Contribution: $'+ numberWithCommas(p.amount) +' • Dream Funding: $'+ numberWithCommas(p.funding) +' • '+p.status+'</div>';
    projectsList.appendChild(div);
  });
  if(getById('activeProjectsCount')) getById('activeProjectsCount').innerText = projects.length;
}

/* ---------- Edit Profile upload (safe) ---------- */
let pendingImageData = null;
if(profileImageFile) profileImageFile.addEventListener('change', ()=>{
  const f = profileImageFile.files[0];
  if(!f) return showToast('Choose an image');
  if(!f.type.startsWith('image/')) return showToast('Image required');
  const r = new FileReader();
  r.onload = e => {
    pendingImageData = e.target.result;
    if(profilePreview) profilePreview.innerHTML = '<img src="'+pendingImageData+'" style="width:100%;height:100%;object-fit:cover">';
  };
  r.readAsDataURL(f);
});
if(editCancel) editCancel.addEventListener('click', ()=> { closeModal(editProfileModal); pendingImageData=null; if(profileImageFile) profileImageFile.value=''; if(profilePreview) profilePreview.innerHTML='No image'; });
if(editCloseX) editCloseX.addEventListener('click', ()=> { closeModal(editProfileModal); pendingImageData=null; if(profileImageFile) profileImageFile.value=''; if(profilePreview) profilePreview.innerHTML='No image'; });

if(saveProfileBtn) saveProfileBtn.addEventListener('click', ()=>{
  const pwd = newPassword ? newPassword.value.trim() : '';
  const nameVal = editName ? editName.value.trim() : '';
  if(pendingImageData){
    safeSetProfileImage(pendingImageData);
    pendingImageData = null;
    if(profileImageFile) profileImageFile.value = '';
    if(profilePreview) profilePreview.innerHTML = 'No image';
  }
  let user = JSON.parse(localStorage.getItem('user') || '{}');
  if(nameVal){
    user.name = nameVal;
    if(getById('welcomeTitle')) getById('welcomeTitle').innerText = translations[getLang()].welcome + user.name;
    if(getById('menuName')) getById('menuName').innerText = user.name;
    setInitialsFromName(user.name);
  }
  if(pwd){
    user.password = pwd;
    if(newPassword) newPassword.value = '';
    showToast('Password saved (demo)');
  }
  localStorage.setItem('user', JSON.stringify(user));
  showToast('Profile updated');
  closeModal(editProfileModal);
});

/* ---------- Settings modal behavior (NEW) ---------- */
if(settingsUploadBtn) settingsUploadBtn.addEventListener('click', ()=> settingsImageFile.click());
if(settingsImageFile) settingsImageFile.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return showToast('Choose an image');
  if(!f.type.startsWith('image/')) return showToast('Image required');
  const r = new FileReader();
  r.onload = e => {
    pendingSettingsImage = e.target.result;
    if(settingsPreview) settingsPreview.innerHTML = '<img src="'+pendingSettingsImage+'" style="width:100%;height:100%;object-fit:cover">';
  };
  r.readAsDataURL(f);
});
let pendingSettingsImage = null;

if(toggle2faBtn) toggle2faBtn.addEventListener('click', ()=>{
  const enabled = localStorage.getItem('2faEnabled') === 'true';
  if(!enabled){
    const secret = 'DBP-' + Math.random().toString(36).slice(2,10).toUpperCase();
    localStorage.setItem('2faEnabled','true'); localStorage.setItem('2faSecret', secret);
    if(twoFaSecret) twoFaSecret.innerText = secret;
    const qrSrc = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent('otpauth://totp/DreamBig?secret='+secret);
    if(twoFaQRCode) twoFaQRCode.innerHTML = '<img src="'+qrSrc+'" style="width:100%;height:100%;object-fit:cover">';
    if(twoFaArea) twoFaArea.style.display = 'flex';
    if(toggle2faBtn) toggle2faBtn.innerText = 'Disconnect 2FA';
    showToast('2FA connected (demo)');
  } else {
    localStorage.removeItem('2faEnabled'); localStorage.removeItem('2faSecret');
    if(twoFaArea) twoFaArea.style.display = 'none';
    if(toggle2faBtn) toggle2faBtn.innerText = 'Connect 2FA';
    showToast('2FA disconnected (demo)');
  }
});
if(copy2faSecret) copy2faSecret.addEventListener('click', ()=> { const s = localStorage.getItem('2faSecret'); if(s) copyText(s); else showToast('No secret'); });

if(settingsCancel) settingsCancel.addEventListener('click', ()=> closeModal(settingsModal));
if(settingsCloseX) settingsCloseX.addEventListener('click', ()=> closeModal(settingsModal));

if(settingsSave) settingsSave.addEventListener('click', ()=>{
  const nameVal = settingsName ? settingsName.value.trim() : '';
  const pwdVal = settingsPassword ? settingsPassword.value.trim() : '';
  const lang = langSelect ? langSelect.value : 'en';
  const theme = themeSelect ? themeSelect.value : 'light';
  if(pendingSettingsImage){
    safeSetProfileImage(pendingSettingsImage);
    if(settingsPreview) settingsPreview.innerHTML = 'No image';
    pendingSettingsImage = null;
    if(settingsImageFile) settingsImageFile.value = '';
  }
  let user = JSON.parse(localStorage.getItem('user') || '{}');
  if(nameVal){
    user.name = nameVal;
    if(getById('welcomeTitle')) getById('welcomeTitle').innerText = translations[getLang()].welcome + user.name;
    if(getById('menuName')) getById('menuName').innerText = user.name;
    setInitialsFromName(user.name);
  }
  if(pwdVal){ user.password = pwdVal; showToast('Password saved (demo)'); }
  localStorage.setItem('user', JSON.stringify(user));
  localStorage.setItem('lang', lang);
  applyTranslations();
  localStorage.setItem('theme', theme);
  applyTheme();
  showToast('Settings saved');
  closeModal(settingsModal);
});

/* ---------- Copy btns ---------- */
document.querySelectorAll('.copy-btn').forEach(btn=> btn.addEventListener('click', (e)=> {
  const key = e.currentTarget.getAttribute('data-copy');
  if(key === 'bankAcct') copyText(getById('bankAcct').innerText.trim());
  if(key === 'walletAddr') copyText(getById('walletAddr').innerText.trim());
}));

/* ---------- QR ---------- */
if(getById('showQR')){
  getById('showQR').addEventListener('click', ()=>{
    const addr = getById('walletAddr').innerText.trim();
    const src = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(addr);
    if(qrImage) qrImage.innerHTML = '<img src="'+src+'" style="width:100%;height:100%;object-fit:cover">';
    closeModal(contributeModal); openModal(qrModal);
  });
}
if(qrClose) qrClose.addEventListener('click', ()=> closeModal(qrModal));
if(qrCloseX) qrCloseX.addEventListener('click', ()=> closeModal(qrModal));

/* ---------- Payments & Projects controls ---------- */
if(paymentsClose) paymentsClose.addEventListener('click', ()=> closeModal(paymentsModal));
if(paymentsCloseX) paymentsCloseX.addEventListener('click', ()=> closeModal(paymentsModal));
if(projectsClose) projectsClose.addEventListener('click', ()=> closeModal(projectsModal));
if(projectsCloseX) projectsCloseX.addEventListener('click', ()=> closeModal(projectsModal));

/* ---------- Logout ---------- */
if(btnNo) btnNo.addEventListener('click', ()=> closeModal(logoutModal));
if(btnYes) btnYes.addEventListener('click', ()=> { closeModal(logoutModal); getById('appRoot').style.opacity = '0.25'; setTimeout(()=> location.href = 'login.html', 900); });
if(getById('mLogout')) getById('mLogout').addEventListener('click', ()=> { closeMenu(); openModal(logoutModal); });

/* ---------- Withdraw handler ---------- */
if(mWithdraw) mWithdraw.addEventListener('click', ()=> { closeMenu(); window.location.href = 'withdraw.html'; });

/* ---------- Sharing ---------- */
if(shareHere) shareHere.addEventListener('click', async ()=>{
  const url = location.href; const lang = getLang();
  const obj = { title: translations[lang].shareText, text: translations[lang].shareText, url };
  if(navigator.share){ try{ await navigator.share(obj); } catch(e){} } else if(navigator.clipboard){ navigator.clipboard.writeText(url).then(()=> showToast('Referral copied')); } else showToast('Copy: '+url);
});

/* ---------- Settings open helper ---------- */
function openSettings(){
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  if(settingsName) settingsName.value = user.name || '';
  if(settingsPassword) settingsPassword.value = '';
  const img = localStorage.getItem('profileImage');
  if(img && settingsPreview) settingsPreview.innerHTML = '<img src="'+img+'" style="width:100%;height:100%;object-fit:cover">';
  else if(settingsPreview) settingsPreview.innerHTML = 'No image';
  const lang = localStorage.getItem('lang') || 'en';
  if(langSelect) langSelect.value = lang;
  const theme = localStorage.getItem('theme') || 'light';
  if(themeSelect) themeSelect.value = theme;
  const twofa = localStorage.getItem('2faEnabled') === 'true';
  if(toggle2faBtn) toggle2faBtn.innerText = twofa ? 'Disconnect 2FA' : 'Connect 2FA';
  if(twofa){
    const secret = localStorage.getItem('2faSecret') || '';
    if(twoFaSecret) twoFaSecret.innerText = secret;
    const qrSrc = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent('otpauth://totp/DreamBig?secret='+secret);
    if(twoFaQRCode) twoFaQRCode.innerHTML = '<img src="'+qrSrc+'" style="width:100%;height:100%;object-fit:cover">';
    if(twoFaArea) twoFaArea.style.display = 'flex';
  } else if(twoFaArea) twoFaArea.style.display = 'none';
  openModal(settingsModal);
}

/* ---------- Translations and Theme ---------- */
function getLang(){ return localStorage.getItem('lang') || 'en'; }
function applyTranslations(){
  const lang = getLang();
  if(getById('dashboardTitle')) getById('dashboardTitle').innerText = translations[lang].dashboard;
  if(getById('kpiActiveLabel')) getById('kpiActiveLabel').innerText = translations[lang].activeProjects;
  if(getById('kpiContributionLabel')) getById('kpiContributionLabel').innerText = translations[lang].totalContribution;
  if(getById('kpiReferralsLabel')) getById('kpiReferralsLabel').innerText = translations[lang].referrals;
  if(getById('referralHint')) getById('referralHint').innerText = translations[lang].referralsHint;
  if(getById('contribLabel')) getById('contribLabel').innerText = translations[lang].contribution;
  if(getById('welcomeTitle')) getById('welcomeTitle').innerText = translations[lang].welcome + (JSON.parse(localStorage.getItem('user')||'{}').name || 'Member');
  if(getById('referralsTitle')) getById('referralsTitle').innerText = translations[lang].referralsTitle;
}
function applyTheme(){
  const theme = localStorage.getItem('theme') || 'light';
  if(theme === 'navy') document.documentElement.classList.add('theme-navy');
  else document.documentElement.classList.remove('theme-navy');
}

/* ---------- Menu header view/hide ---------- */
if(menuViewToggle) menuViewToggle.addEventListener('click', ()=>{
  const hidden = menuName.style.visibility === 'hidden';
  if(hidden){ menuName.style.visibility = 'visible'; menuViewToggle.innerText = 'Hide'; } else { menuName.style.visibility = 'hidden'; menuViewToggle.innerText = 'View'; }
});

/* ---------- Init UI state ---------- */
function updateReferralsUI(){
  const refs = parseInt(localStorage.getItem('referrals')||'0',10);
  if(getById('refersNum')) getById('refersNum').innerText = refs;
}
function init(){
  const meta = getById('metaDate');
  if(meta && !meta.innerText) { const d=new Date(); meta.innerText = (d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear(); }
  const savedImg = localStorage.getItem('profileImage');
  if(savedImg){
    if(profileImg){ profileImg.src = savedImg; profileImg.style.display='block'; }
    if(profileInitials) profileInitials.style.display='none';
    if(dbLogo) dbLogo.innerHTML = '<img src="'+savedImg+'">';
    if(menuThumb) menuThumb.innerHTML = '<img src="'+savedImg+'" style="width:100%;height:100%;object-fit:cover">';
  }
  const pkg = JSON.parse(localStorage.getItem('selectedPackage') || 'null');
  if(pkg){
    if(projectName) projectName.innerText = pkg.name + ' Package';
    if(projectMeta) projectMeta.innerText = pkg.name + ' • Package selected';
    if(packageAmount) packageAmount.innerText = '(' + pkg.name + ' Contribution)';
    if(dreamFunding) dreamFunding.innerText = 'Dream Funding: $' + numberWithCommas(pkg.funding);
    if(progressTarget) progressTarget.innerText = 'Target: $' + numberWithCommas(pkg.funding);
    const savedPct = Number(localStorage.getItem('progressPercent') || '0');
    updateProgress(savedPct);
  } else {
    updateProgress(0);
  }
  refreshPaymentsNav(); renderProjects(); updateReferralsUI(); applyTranslations(); applyTheme();
  initTypedBanner(); // start typed banner (3s delay inside)
}
init();

/* ---------- copy actions ---------- */
document.querySelectorAll('.copy-btn').forEach(btn=>{
  btn.addEventListener('click', e=>{
    const key = btn.getAttribute('data-copy');
    if(key === 'bankAcct') copyText(getById('bankAcct').innerText.trim());
    if(key === 'walletAddr') copyText(getById('walletAddr').innerText.trim());
  });
});

/* ---------- menu close on ESC ---------- */
document.addEventListener('keyup', (e)=> { if(e.key === 'Escape') { closeMenu(); closeModal(settingsModal); closeModal(editProfileModal); closeModal(contributeModal); } });

/* ---------- profile menu quick bindings ---------- */
if(getById('profileLogoutBtn')) getById('profileLogoutBtn').addEventListener('click', ()=> { closeMenu(); openModal(logoutModal); });

/* ---------- expose openSettings for debug/demo ---------- */
window.openSettings = openSettings;

/* ---------- TYPED BANNER LOGIC (single run, starts 3s after page load) ---------- */
function initTypedBanner(){
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const typedSmall = getById('typedSmall');
  const typedMain = getById('typedMain');
  const bannerCaret = getById('bannerCaret');
  if(!typedMain) return;
  const mainText = 'MAKE IT HAPPEN . SHOCK THE WORLD';
  const typeSpeed = 60;
  if(prefersReduced){
    if(typedSmall) typedSmall.textContent = '';
    typedMain.textContent = mainText;
    if(bannerCaret) bannerCaret.style.display = 'none';
    return;
  }
  if(typedSmall) typedSmall.textContent = '';
  // start typing once after 3 seconds
  setTimeout(() => {
    let i = 0;
    if(bannerCaret) bannerCaret.style.display = 'inline-block';
    typedMain.textContent = '';
    const t = setInterval(() => {
      typedMain.textContent += mainText.charAt(i);
      i++;
      if(i >= mainText.length){
        clearInterval(t);
        if(bannerCaret) setTimeout(()=> bannerCaret.style.display = 'none', 500);
      }
    }, typeSpeed);
  }, 3000);
}
</script>
</body>
</html><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Dream Big — Dashboard</title>
<meta name="theme-color" content="#071a2a"/>
<style>
  /* ---------- Theme variables (base are light/white-blue) ---------- */
  :root{
    --bg:#f6f9fc;               /* light bg */
    --card:#ffffff;             /* card */
    --muted:#6b7d8c;            /* muted text */
    --accent:#1ea7ff;           /* primary blue accent */
    --accent-contrast:#042137;  /* text on accent */
    --danger:#e14b4b;
    --text:#042137;             /* primary text (dark) */
    --brand-radius:12px;
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  }

  /* navy/gold theme values (applied when theme === navy) */
  .theme-navy {
    --bg: linear-gradient(180deg,#021226 0%, #071a2a 100%);
    --card: linear-gradient(180deg,#072235,#0f2a44);
    --muted: #9fb3c7;
    --accent: #f6c44b;
    --accent-contrast: #042137;
    --danger: #e14b4b;
    --text: #eaf6ff;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text)}
  .app{min-height:100vh;display:flex;flex-direction:column;padding:16px;gap:12px;transition:opacity .45s}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;z-index:50}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:var(--accent-contrast);font-weight:800;font-size:16px;overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:8px}
  .title{font-size:16px;font-weight:700}
  .meta{font-size:12px;color:var(--muted)}
  /* ensure hamburger sits above overlay so it's always clickable */
  .menu-btn{width:46px;height:46px;border-radius:12px;background:var(--card);display:flex;align-items:center;justify-content:center;border:none;color:var(--muted);font-weight:800;font-size:20px;position:relative;z-index:120}
  .overlay-dim{position:fixed;inset:0;background:rgba(0,0,0,0.45);opacity:0;pointer-events:none;transition:opacity 220ms ease;z-index:100}
  .overlay-dim.visible{opacity:1;pointer-events:auto}
  .menu-panel{position:fixed;top:72px;right:12px;width:92%;max-width:360px;background:var(--card);border-radius:14px;padding:10px;box-shadow:0 20px 60px rgba(0,0,0,0.08);transform-origin:top right;opacity:0;pointer-events:none;transform:translateY(-8px) scale(.98);transition:all 220ms cubic-bezier(.2,.9,.2,1);z-index:110;color:var(--text)}
  .menu-panel.open{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}
  .menu-item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;color:var(--muted);background:transparent;border:none;width:100%;text-align:left;font-weight:700;font-size:15px}
  .menu-item:hover{background:rgba(0,0,0,0.02);color:var(--text)}
  .menu-item .hint{font-size:12px;color:var(--muted);font-weight:600}
  /* profile circle removed visually - kept in DOM for backward compat but hidden */
  .profile{display:none}
  .profile img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .profile-initials{font-weight:800;color:var(--muted)}
  main{flex:1;overflow:auto;padding-bottom:110px}
  .welcome{background:var(--card);padding:14px;border-radius:16px;box-shadow:0 6px 18px rgba(2,6,20,0.04)}
  .writeup{margin-top:12px;color:var(--muted);line-height:1.45}
  .kpis{display:flex;gap:8px;margin-top:12px}
  .kpi{flex:1;padding:10px;background:rgba(0,0,0,0.02);border-radius:12px;text-align:left}
  .kpi .num{font-size:18px;font-weight:800}
  .card{background:var(--card);padding:14px;border-radius:16px;margin-top:14px}
  .form-row{display:flex;gap:8px;margin-top:12px}
  .input,select{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:transparent;color:var(--text);font-size:14px}
  .submit{background:var(--accent);color:var(--accent-contrast);padding:10px 14px;border-radius:10px;border:none;font-weight:700}
  /* progress bar */
  .progress-track { width:100%; background: rgba(0,0,0,0.06); height:14px; border-radius:999px; overflow:hidden; margin-top:10px; }
  .progress-fill { height:100%; width:0%; background:var(--accent); transition: width .6s cubic-bezier(.2,.9,.2,1), background .25s ease; box-shadow: 0 8px 30px rgba(0,0,0,0.08); border-radius:999px; }
  .progress-label { display:flex; justify-content:space-between; margin-top:8px; color:var(--muted); font-size:13px; }
  /* Footer: accent separator + simple copyright */
  footer{position:fixed;left:12px;right:12px;bottom:12px;background:var(--card);padding:12px;border-radius:12px;display:flex;align-items:center;box-shadow:0 8px 30px rgba(2,6,20,0.06);z-index:40;border-top:4px solid var(--accent);justify-content:center;color:var(--muted)}
  .btn{padding:10px 12px;border-radius:10px;border:none}
  .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(0,0,0,0.04)}
  .btn.warn{background:var(--danger);color:white}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:46}
  .modal{background:var(--card);padding:18px;border-radius:12px;min-width:280px;box-shadow:0 8px 30px rgba(0,0,0,0.08);position:relative;color:var(--text)}
  .modal h3{margin:0 0 6px 0;color:var(--text)}
  .modal p{color:var(--muted);margin:0 0 12px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end}
  .close-x{position:absolute;right:12px;top:10px;background:transparent;border:none;color:var(--danger);font-weight:900;font-size:20px;border-radius:6px;padding:6px}
  .proof-area{margin-top:12px;background:rgba(0,0,0,0.02);padding:12px;border-radius:10px}
  .file-preview{margin-top:8px;background:rgba(0,0,0,0.02);padding:8px;border-radius:8px}
  .profile-menu{position:absolute;top:62px;right:12px;background:var(--card);padding:8px;border-radius:10px;min-width:160px;display:none;box-shadow:0 8px 30px rgba(0,0,0,0.08);z-index:50}
  .profile-menu button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:none;background:transparent;color:var(--text);font-weight:700}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:110px;background:rgba(0,0,0,0.75);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:80;font-weight:700}
  .menu-header{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;margin-bottom:8px}
  .menu-header .hdr-name{font-weight:800}
  .small-pill{padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.02);font-weight:700;font-size:13px;color:var(--muted)}
  @media(min-width:540px){.app{padding:20px}}

  /* ---------- Typed banner styles (new) ---------- */
  .typed-banner { margin-top:10px; text-align:center; user-select:none; }
  .typed-banner .small-word { display:block; font-weight:900; font-size:12px; opacity:0.46; letter-spacing:1.4px; margin-bottom:6px; text-transform:uppercase; }
  .typed-banner .main-line { display:block; font-weight:900; font-size:20px; text-transform:uppercase; letter-spacing:0.8px; min-height:1.2em; }
  .typed-banner .banner-caret { display:inline-block; width:10px; height:1.05em; vertical-align:middle; background:var(--accent); margin-left:8px; border-radius:2px; animation: tb-blink 900ms steps(2,start) infinite; }
  @keyframes tb-blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }
  @media(min-width:900px){ .typed-banner .main-line { font-size:24px; } }
  @media(max-width:520px){ .typed-banner .main-line { font-size:16px; } }

  @media (prefers-reduced-motion: reduce) {
    .typed-banner .banner-caret { display:none !important; }
  }

</style>
</head>
<body>
  <div class="app" id="appRoot">

    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="logo" id="dbLogo">
          <!-- logo image inserted here if profile image saved -->
        </div>
        <div>
          <div class="title" id="dashboardTitle">Dashboard</div>
          <div class="meta" id="metaDate"></div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <!-- Hamburger moved to the top-right (profile circle hidden visually via CSS) -->
        <button class="menu-btn" id="menuBtn" aria-label="Open menu" aria-expanded="false">☰</button>

        <!-- profile circle kept in DOM for backwards compatibility but hidden -->
        <div class="profile" id="profileCircle" title="Profile">
          <img id="profileImg" alt="Profile" style="display:none">
          <span id="profileInitials" class="profile-initials">PD</span>

          <div class="profile-menu" id="profileMenu" role="menu" aria-hidden="true">
            <button id="viewProfileBtn">View Profile</button>
            <button id="editProfileBtn">Edit Profile</button>
            <hr style="border:none;border-top:1px solid rgba(0,0,0,0.04);margin:8px 0">
            <button id="profileLogoutBtn" style="color:var(--danger)">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <div class="overlay-dim" id="overlayDim" tabindex="-1"></div>

    <!-- MENU PANEL -->
    <div class="menu-panel" id="menuPanel" aria-hidden="true">
      <!-- new header: small profile + name + view/hide -->
      <div class="menu-header" id="menuHeader" style="background:transparent">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:36px;height:36px;border-radius:50%;overflow:hidden;background:var(--accent);display:grid;place-items:center" id="menuThumb">
            <!-- small thumb inserted -->
          </div>
          <div>
            <div class="hdr-name" id="menuName">Member Name</div>
            <div style="font-size:12px;color:var(--muted)" id="menuRole">Member</div>
          </div>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
          <button class="small-pill" id="menuViewToggle">Hide</button>
        </div>
      </div>

      <!-- Wallet added as first item -->
      <button class="menu-item" id="mWallet"><span>Wallet</span><span class="hint" id="walletHint">$0.00</span></button>

      <!-- Contribution and other items -->
      <button class="menu-item" id="mContribute"><span id="contribLabel">Contribution</span><span class="hint" id="contribHint">Contribution</span></button>
      <button class="menu-item" id="mViewProjects">View Projects<span class="hint">Your projects</span></button>
      <button class="menu-item" id="mWithdraw">Withdraw<span class="hint">Request</span></button>
      <button class="menu-item" id="mHelp">Help & Support<span class="hint">Contact</span></button>
      <div id="paymentsNavPlace"></div>
      <button class="menu-item" id="mSettings">Settings<span class="hint">Preferences</span></button>
      <button class="menu-item" id="mLogout">Logout<span class="hint">Sign out</span></button>
    </div>

    <main>
      <section class="welcome">
        <h2 id="welcomeTitle">Welcome, Member</h2>

        <!-- small write-up you asked for -->
        <p class="writeup">Dream Big Project helps individuals and communities move from an idea to funded, disciplined execution. Contribute, track your project, invite others and grow together.</p>

        <!-- NEW: Typed banner placed directly under welcome,
             will start typing once (after 3s) -->
        <div id="typedBanner" class="typed-banner" aria-live="polite" aria-atomic="true">
          <span class="small-word" id="typedSmall" aria-hidden="true"></span>
          <span class="main-line" id="typedMain" aria-hidden="true"></span>
          <span class="banner-caret" id="bannerCaret" aria-hidden="true" style="display:none"></span>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="num" id="activeProjectsCount">0</div><div style="font-size:12px;color:var(--muted)" id="kpiActiveLabel">Active Projects</div></div>
          <div class="kpi"><div class="num" id="totalContribution">$0</div><div style="font-size:12px;color:var(--muted)" id="kpiContributionLabel">Total Contribution</div></div>
          <div class="kpi"><div class="num" id="refersNum">0</div><div style="font-size:12px;color:var(--muted)" id="kpiReferralsLabel">Referrals</div></div>
        </div>
      </section>

      <article class="card">
        <div class="project-title">
          <div>
            <div style="font-weight:800" id="projectName">No project selected</div>
            <div style="font-size:12px;color:var(--muted)" id="projectMeta">No Dream Funding selected</div>
          </div>
          <div style="text-align:right;color:var(--muted)"><div style="font-weight:800" id="packageAmount"></div></div>
        </div>

        <!-- spaced paragraph(s) so bar can move below -->
        <div style="margin-top:18px;"></div>

        <!-- Dream Funding only (removed dot & contribution) -->
        <div id="dreamFunding" style="font-weight:800;color:var(--muted);margin-top:6px">Dream Funding: $0</div>

        <!-- Progress bar below dream funding -->
        <div class="progress-track" aria-hidden="true" id="progressTrack">
          <div class="progress-fill" id="progressFill" style="width:0%"></div>
        </div>
        <div class="progress-label">
          <div id="progressPct">0%</div>
          <div id="progressTarget">Target: —</div>
        </div>

      </article>

      <section class="card">
        <div style="font-weight:800" id="referralsTitle">Referrals</div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px" id="referralHint">Referrals are counted only after payments are approved by admin.</div>
        <div style="margin-top:10px"><button class="btn ghost" id="shareHere">Share Referral Link</button></div>
      </section>

    </main>

    <footer>
      <div style="font-size:13px">© 2026 Dream Big Project — All rights reserved.</div>
    </footer>

    <div class="toast" id="toast">Copied!</div>

    <!-- ========== MODALS ========== -->

    <!-- Wallet modal -->
    <div class="modal-backdrop" id="walletModal">
      <div class="modal" role="document">
        <button class="close-x" id="walletCloseX" title="Close">✕</button>
        <h3>Wallet</h3>
        <p style="color:var(--muted)">Quick view of your wallet balance and actions.</p>
        <div style="margin-top:12px;font-weight:800;font-size:20px" id="walletBalance">$0.00</div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="addFundsBtn">Add Funds</button>
          <button class="btn ghost" id="withdrawBtn">Withdraw</button>
        </div>
      </div>
    </div>

    <!-- Contribution modal -->
    <div class="modal-backdrop" id="contributeModal">
      <div class="modal" role="document">
        <button class="close-x" id="contribCloseX" title="Close">✕</button>
        <h3>Contribute</h3>
        <p>Choose a package, then select payment method (Bank or USDT TRC20). After payment, submit proof or paste TX hash.</p>
        <div style="margin-top:10px">
          <select class="input" id="packageSelect">
            <option value="">-- Select Package --</option>
            <option value="25">$25</option>
            <option value="50">$50</option>
            <option value="75">$75</option>
            <option value="100">$100</option>
            <option value="125">$125</option>
            <option value="150">$150</option>
            <option value="175">$175</option>
            <option value="200">$200</option>
            <option value="250">$250</option>
            <option value="300">$300</option>
            <option value="400">$400</option>
            <option value="500">$500</option>
            <option value="1000">$1000</option>
            <option value="5000">$5000</option>
            <option value="10000">$10000</option>
            <option value="50000">$50000</option>
            <option value="100000">$100000</option>
          </select>
        </div>
        <div style="margin-top:10px">
          <button class="btn ghost" id="methodBank">Bank Deposit</button>
          <button class="btn ghost" id="methodUSDT">USDT (TRC20)</button>
        </div>
        <div id="bankBlock" style="margin-top:12px;display:none">
          <div class="copy"><span class="label">Bank: FIRST NATIONAL BANK</span>
            <div>Account Name: DREAM BIG PROJECT</div>
            <div>Account Number: <strong id="bankAcct">0123456789</strong></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost copy-btn" data-copy="bankAcct">Copy Account</button>
          </div>
        </div>
        <div id="usdtBlock" style="margin-top:12px;display:none">
          <div class="copy"><span class="label">TRC20 Wallet (USDT)</span>
            <div id="walletAddr" style="word-break:break-all"><strong>TXxExampleWalletAddress1234567890abcdef</strong></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost copy-btn" data-copy="walletAddr">Copy Wallet</button>
            <button class="btn ghost" id="showQR">Show QR</button>
          </div>
        </div>
        <div style="margin-top:12px">
          <button class="btn" id="iPaidBtn">I have paid</button>
        </div>
        <div class="proof-area" id="proofArea" style="display:none">
          <button class="close-x" id="proofCloseX" title="Close">✕</button>
          <div style="font-weight:800" id="proofTitle">Upload proof or paste TX hash</div>
          <div style="font-size:13px;color:var(--muted);margin-top:6px" id="proofHint">Bank: upload image/PDF. USDT: paste transaction hash.</div>
          <div id="bankProofInputs" style="margin-top:8px;display:none">
            <div style="display:flex;gap:8px;align-items:center">
              <input type="file" id="proofFile" accept="image/*,.pdf">
              <button class="btn ghost" id="previewProof">Preview</button>
            </div>
            <div class="file-preview" id="filePreview" style="display:none;position:relative">
              <button class="close-x" id="previewCloseX" title="Close">✕</button>
              <div id="filePreviewInner"></div>
            </div>
          </div>
          <div id="usdtHashInput" style="margin-top:8px;display:none">
            <input class="input" id="txHash" placeholder="Paste transaction hash here">
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">Be sure the TX is confirmed on TRON network.</div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="cancelProof">Cancel</button>
            <button class="btn" id="submitProof">Submit</button>
          </div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button class="btn ghost" id="contribClose">Close</button>
        </div>
      </div>
    </div>

    <!-- Edit Profile modal (kept but profile circle hidden) -->
    <div class="modal-backdrop" id="editProfileModal">
      <div class="modal">
        <button class="close-x" id="editCloseX">✕</button>
        <h3>Edit Profile</h3>
        <p style="color:var(--muted)">Upload a facial image and change name or password. (Email is not editable here.)</p>
        <div style="margin-top:8px">
          <input type="file" id="profileImageFile" accept="image/*">
        </div>
        <div style="margin-top:10px">
          <div id="profilePreview" style="width:120px;height:120px;border-radius:8px;overflow:hidden;background:rgba(0,0,0,0.02);display:grid;place-items:center">No image</div>
        </div>
        <div style="margin-top:10px">
          <input class="input" id="editName" placeholder="Full name" type="text">
        </div>
        <div style="margin-top:10px">
          <input class="input" id="newPassword" placeholder="New password" type="password">
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn ghost" id="editCancel">Cancel</button>
          <button class="btn" id="saveProfileBtn">Save</button>
        </div>
      </div>
    </div>

    <!-- Settings modal (NEW) -->
    <div class="modal-backdrop" id="settingsModal">
      <div class="modal">
        <button class="close-x" id="settingsCloseX">✕</button>
        <h3>Settings</h3>
        <p style="color:var(--muted)">Manage profile image, name, password, 2FA, language and theme.</p>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
          <div style="width:80px;height:80px;border-radius:10px;overflow:hidden;background:rgba(0,0,0,0.02);display:grid;place-items:center" id="settingsPreview">No image</div>
          <div style="flex:1">
            <input class="input" id="settingsName" placeholder="Full name">
            <div style="margin-top:8px;display:flex;gap:8px">
              <input class="input" id="settingsPassword" placeholder="New password" type="password">
              <button class="btn ghost" id="settingsUploadBtn">Choose Image</button>
            </div>
            <input type="file" id="settingsImageFile" accept="image/*" style="display:none">
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label style="font-weight:700;font-size:13px">Two-Factor Authentication</label>
            <div style="font-size:13px;color:var(--muted)">Enable or disable 2FA for extra account security.</div>
          </div>
          <div>
            <button class="btn ghost" id="toggle2faBtn">Connect 2FA</button>
          </div>
        </div>
        <div id="twoFaArea" style="margin-top:8px;display:none">
          <div style="font-size:13px;color:var(--muted)">Scan this code in your authenticator app (demo), or copy secret:</div>
          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <div id="twoFaQRCode" style="width:120px;height:120px;border-radius:8px;overflow:hidden;background:#fff;display:grid;place-items:center"></div>
            <div>
              <div id="twoFaSecret" style="font-weight:800"></div>
              <div style="margin-top:8px"><button class="btn ghost" id="copy2faSecret">Copy</button></div>
            </div>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <div style="flex:1">
            <label style="font-weight:700;font-size:13px">Language</label>
            <select class="input" id="langSelect" style="margin-top:6px">
              <option value="en">English</option>
              <option value="fr">Français</option>
            </select>
          </div>
          <div style="flex:1">
            <label style="font-weight:700;font-size:13px">Theme</label>
            <select class="input" id="themeSelect" style="margin-top:6px">
              <option value="light">Light (white & blue)</option>
              <option value="navy">Navy & gold</option>
            </select>
          </div>
        </div>
        <div class="actions" style="margin-top:14px">
          <button class="btn ghost" id="settingsCancel">Cancel</button>
          <button class="btn" id="settingsSave">Save Settings</button>
        </div>
      </div>
    </div>

    <!-- Payments modal (unchanged) -->
    <div class="modal-backdrop" id="paymentsModal">
      <div class="modal">
        <button class="close-x" id="paymentsCloseX">✕</button>
        <h3 id="paymentsTitle">Payments</h3>
        <div id="paymentsListArea" style="margin-top:10px"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="paymentsClose">Close</button></div>
      </div>
    </div>

    <!-- Projects modal (unchanged) -->
    <div class="modal-backdrop" id="projectsModal">
      <div class="modal">
        <button class="close-x" id="projectsCloseX">✕</button>
        <h3>Your Projects</h3>
        <div class="projects-list" id="projectsList" style="margin-top:10px"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="projectsClose">Close</button></div>
      </div>
    </div>

    <!-- Simple logout confirm modal (unchanged) -->
    <div class="modal-backdrop" id="logoutModal">
      <div class="modal">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to log out?</p>
        <div class="actions">
          <button class="btn ghost" id="btnNo">No</button>
          <button class="btn warn" id="btnYes">Yes</button>
        </div>
      </div>
    </div>

    <!-- QR modal (unchanged) -->
    <div class="modal-backdrop" id="qrModal">
      <div class="modal" style="text-align:center">
        <button class="close-x" id="qrCloseX">✕</button>
        <h3>USDT (TRC20) QR</h3>
        <div id="qrImage" style="margin:12px auto;width:220px;height:220px;border-radius:12px;overflow:hidden;background:#fff;display:grid;place-items:center"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="qrClose">Close</button></div>
      </div>
    </div>

  </div>

<script>
/* ---------- Utilities ---------- */
function numberWithCommas(x){
  if(x === undefined || x === null) return '';
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
const getById = id => document.getElementById(id);

/* ---------- Refs ---------- */
const menuBtn = getById('menuBtn');
const menuPanel = getById('menuPanel');
const overlayDim = getById('overlayDim');
const mWallet = getById('mWallet');
const mContribute = getById('mContribute');
const mViewProjects = getById('mViewProjects');
const mHelp = getById('mHelp');
const mSettings = getById('mSettings');
const mLogout = getById('mLogout');
const mWithdraw = getById('mWithdraw');
const paymentsNavPlace = getById('paymentsNavPlace');

const walletModal = getById('walletModal');
const walletCloseX = getById('walletCloseX');
const walletBalance = getById('walletBalance');
const addFundsBtn = getById('addFundsBtn');
const withdrawBtn = getById('withdrawBtn');

const profileCircle = getById('profileCircle');
const profileImg = getById('profileImg');
const profileInitials = getById('profileInitials');
const profileMenu = getById('profileMenu');
const viewProfileBtn = getById('viewProfileBtn');
const editProfileBtn = getById('editProfileBtn');
const profileLogoutBtn = getById('profileLogoutBtn');

const contributeModal = getById('contributeModal');
const contribClose = getById('contribClose');
const contribCloseX = getById('contribCloseX');
const methodBankBtn = getById('methodBank');
const methodUSDTBtn = getById('methodUSDT');
const bankBlock = getById('bankBlock');
const usdtBlock = getById('usdtBlock');
const iPaidBtn = getById('iPaidBtn');
const proofArea = getById('proofArea');
const proofCloseX = getById('proofCloseX');
const bankProofInputs = getById('bankProofInputs');
const usdtHashInput = getById('usdtHashInput');
const proofFile = getById('proofFile');
const previewProofBtn = getById('previewProof');
const filePreview = getById('filePreview');
const filePreviewInner = getById('filePreviewInner');
const previewCloseX = getById('previewCloseX');
const cancelProof = getById('cancelProof');
const submitProof = getById('submitProof');
const txHash = getById('txHash');

const packageSelect = getById('packageSelect');
const packageAmount = getById('packageAmount');
const projectName = getById('projectName');
const projectMeta = getById('projectMeta');
const progressPct = getById('progressPct');
const progressTarget = getById('progressTarget');
const progressFill = getById('progressFill');
const dreamFunding = getById('dreamFunding');

const editProfileModal = getById('editProfileModal');
const profileImageFile = getById('profileImageFile');
const profilePreview = getById('profilePreview');
const editName = getById('editName');
const newPassword = getById('newPassword');
const saveProfileBtn = getById('saveProfileBtn');
const editCancel = getById('editCancel');
const editCloseX = getById('editCloseX');

const settingsModal = getById('settingsModal');
const settingsCloseX = getById('settingsCloseX');
const settingsName = getById('settingsName');
const settingsPassword = getById('settingsPassword');
const settingsUploadBtn = getById('settingsUploadBtn');
const settingsImageFile = getById('settingsImageFile');
const settingsPreview = getById('settingsPreview');
const toggle2faBtn = getById('toggle2faBtn');
const twoFaArea = getById('twoFaArea');
const twoFaQRCode = getById('twoFaQRCode');
const twoFaSecret = getById('twoFaSecret');
const copy2faSecret = getById('copy2faSecret');
const langSelect = getById('langSelect');
const themeSelect = getById('themeSelect');
const settingsCancel = getById('settingsCancel');
const settingsSave = getById('settingsSave');

const paymentsModal = getById('paymentsModal');
const paymentsListArea = getById('paymentsListArea');
const paymentsClose = getById('paymentsClose');
const paymentsCloseX = getById('paymentsCloseX');

const projectsModal = getById('projectsModal');
const projectsList = getById('projectsList');
const projectsClose = getById('projectsClose');
const projectsCloseX = getById('projectsCloseX');

const logoutModal = getById('logoutModal');
const btnNo = getById('btnNo'), btnYes = getById('btnYes');

const qrModal = getById('qrModal'), qrImage = getById('qrImage'), qrClose = getById('qrClose'), qrCloseX = getById('qrCloseX');

const dbLogo = getById('dbLogo');
const toast = getById('toast');
const copyButtons = document.querySelectorAll('.copy-btn');
const shareHere = getById('shareHere');

const menuHeader = getById('menuHeader');
const menuThumb = getById('menuThumb');
const menuName = getById('menuName');
const menuViewToggle = getById('menuViewToggle');

let payments = JSON.parse(localStorage.getItem('payments') || '[]');
let projects = JSON.parse(localStorage.getItem('projects') || '[]');

/* ---------- Translations (small demo) ---------- */
const translations = { en: { dashboard: 'Dashboard', activeProjects: 'Active Projects', totalContribution: 'Total Contribution', referrals: 'Referrals', referralsHint: 'Referrals are counted only after payments are approved by admin.', contribution: 'Contribution', welcome: 'Welcome, ', shareText: 'Join me on Dream Big', settings: 'Settings', save: 'Save', cancel: 'Cancel', referralsTitle: 'Referrals' }, fr: { dashboard: 'Tableau de bord', activeProjects: 'Projets actifs', totalContribution: 'Contribution totale', referrals: 'Parrainages', referralsHint: 'Les parrainages sont comptés après approbation des paiements par l\\'admin.', contribution: 'Contribution', welcome: 'Bienvenue, ', shareText: 'Rejoignez-moi sur Dream Big', settings: 'Paramètres', save: 'Enregistrer', cancel: 'Annuler', referralsTitle: 'Parrainages' } };

/* ---------- Utilities ---------- */
function showToast(msg){ if(!toast) return; toast.innerText = msg || 'Copied!'; toast.style.display='block'; toast.style.opacity='1'; setTimeout(()=>{ toast.style.transition='opacity 300ms ease'; toast.style.opacity='0'; setTimeout(()=>{ toast.style.display='none'; toast.style.transition=''; },300); },1400); }
function copyText(text){ if(!text) return showToast('Nothing to copy'); if(navigator.clipboard){ navigator.clipboard.writeText(text).then(()=> showToast('Copied')); } else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showToast('Copied'); } catch(e){ showToast('Copy failed'); } ta.remove(); } }
function openModal(el){ if(!el) return; el.style.display='flex'; el.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function closeModal(el){ if(!el) return; el.style.display='none'; el.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

/* ---------- Robust Menu Toggle (reliable on mobile & desktop) ---------- */
let _docClickHandler = null;
function isMenuOpen(){ return menuPanel && menuPanel.classList.contains('open'); }
function openMenu(){
  if(!menuPanel || !overlayDim) return;
  menuPanel.classList.add('open');
  overlayDim.classList.add('visible');
  menuPanel.setAttribute('aria-hidden','false');
  menuBtn && menuBtn.setAttribute('aria-expanded','true');

  // add single document click handler to close when user clicks outside
  _docClickHandler = function(ev){
    if(menuPanel.contains(ev.target) || menuBtn.contains(ev.target)) return;
    closeMenu();
  };
  document.addEventListener('click', _docClickHandler, { capture: true });
  document.addEventListener('keyup', _onEscape);
}
function closeMenu(){
  if(!menuPanel || !overlayDim) return;
  menuPanel.classList.remove('open');
  overlayDim.classList.remove('visible');
  menuPanel.setAttribute('aria-hidden','true');
  menuBtn && menuBtn.setAttribute('aria-expanded','false');

  if(_docClickHandler) document.removeEventListener('click', _docClickHandler, { capture: true });
  _docClickHandler = null;
  document.removeEventListener('keyup', _onEscape);
}
function toggleMenu(e){
  if(e) e.stopPropagation();
  if(isMenuOpen()) closeMenu(); else openMenu();
}
function _onEscape(e){ if(e.key === 'Escape') closeMenu(); }

menuBtn && menuBtn.addEventListener('click', toggleMenu);
overlayDim && overlayDim.addEventListener('click', closeMenu);
menuPanel && menuPanel.addEventListener('click', (ev)=> ev.stopPropagation());

/* ---------- Wallet Nav behavior ---------- */
if(mWallet){
  mWallet.addEventListener('click', ()=> {
    closeMenu();
    // load quick wallet balance from localStorage (demo)
    const bal = Number(localStorage.getItem('walletBalance') || '0');
    walletBalance && (walletBalance.innerText = '$' + numberWithCommas(bal.toFixed(2) || '0.00'));
    openModal(walletModal);
  });
}
walletCloseX && walletCloseX.addEventListener('click', ()=> closeModal(walletModal));
addFundsBtn && addFundsBtn.addEventListener('click', ()=>{
  closeModal(walletModal);
  closeMenu();
  // open contribute modal as quick path to add funds
  openModal(contributeModal);
});
withdrawBtn && withdrawBtn.addEventListener('click', ()=>{
  closeModal(walletModal);
  // go to withdraw page or open withdraw flow (demo)
  window.location.href = 'withdraw.html';
});

/* ---------- Profile menu (safe guards) ---------- */
if(profileCircle){
  profileCircle.addEventListener('click',(e)=>{
    e.stopPropagation();
    const open = profileMenu.style.display === 'block';
    profileMenu.style.display = open ? 'none' : 'block';
    profileMenu.setAttribute('aria-hidden', open ? 'true' : 'false');
  });
}
document.addEventListener('click',(e)=>{
  if(profileMenu && profileMenu.style.display === 'block' && profileCircle && !profileCircle.contains(e.target)){
    profileMenu.style.display='none'; profileMenu.setAttribute('aria-hidden','true');
  }
});
if(viewProfileBtn) viewProfileBtn.addEventListener('click', ()=>{ if(profileMenu) profileMenu.style.display='none'; alert('Profile view (demo)'); });
if(editProfileBtn) editProfileBtn.addEventListener('click', ()=>{ if(profileMenu) profileMenu.style.display='none'; openModal(editProfileModal); });
if(profileLogoutBtn) profileLogoutBtn.addEventListener('click', ()=>{ if(profileMenu) profileMenu.style.display='none'; openModal(logoutModal); });

/* ---------- Init user & profile image (safe) ---------- */
function safeSetProfileImage(dataUrl){
  if(!dataUrl) return;
  if(profileImg){ profileImg.src = dataUrl; profileImg.style.display = 'block'; }
  if(profileInitials) profileInitials.style.display = 'none';
  if(dbLogo) dbLogo.innerHTML = '<img src="'+dataUrl+'" alt="logo">';
  if(menuThumb) menuThumb.innerHTML = '<img src="'+dataUrl+'" style="width:100%;height:100%;object-fit:cover">';
  localStorage.setItem('profileImage', dataUrl);
}
function setInitialsFromName(name){
  const parts = (name||'').trim().split(' ');
  let initials = 'PD';
  if(parts.length>0 && parts[0].length>0) initials = parts[0][0].toUpperCase() + (parts[1]? parts[1][0].toUpperCase() : '');
  if(profileInitials) profileInitials.innerText = initials;
  if(!localStorage.getItem('profileImage') && menuThumb) menuThumb.innerText = initials;
}
function loadUser(){
  let user = JSON.parse(localStorage.getItem('user') || 'null');
  if(!user || !user.name){
    const name = prompt('Enter your name to continue (demo login):') || 'Member';
    const password = prompt('Choose a password (demo):') || '';
    user = { name, password };
    localStorage.setItem('user', JSON.stringify(user));
  }
  const welcomeEl = getById('welcomeTitle');
  if(welcomeEl) welcomeEl.innerText = translations[getLang()].welcome + user.name;
  if(editName) editName.value = user.name || '';
  if(settingsName) settingsName.value = user.name || '';
  setInitialsFromName(user.name);
  const savedImg = localStorage.getItem('profileImage');
  if(savedImg) safeSetProfileImage(savedImg);
  if(menuName) menuName.innerText = user.name;
}
loadUser();

/* ---------- Contribution modal & flows ---------- */
let preferredMethod = localStorage.getItem('preferredContribution') || 'bank';
function showBank(){ if(bankBlock) bankBlock.style.display='block'; if(usdtBlock) usdtBlock.style.display='none'; preferredMethod='bank'; localStorage.setItem('preferredContribution','bank'); if(getById('contribHint')) getById('contribHint').innerText='Bank Deposit'; }
function showUSDT(){ if(bankBlock) bankBlock.style.display='none'; if(usdtBlock) usdtBlock.style.display='block'; preferredMethod='usdt'; localStorage.setItem('preferredContribution','usdt'); if(getById('contribHint')) getById('contribHint').innerText='USDT (TRC20)'; }
if(methodBankBtn) methodBankBtn.addEventListener('click', showBank);
if(methodUSDTBtn) methodUSDTBtn.addEventListener('click', showUSDT);

if(mContribute) mContribute.addEventListener('click', ()=>{ closeMenu(); openModal(contributeModal); const pref = localStorage.getItem('preferredContribution') || 'bank'; if(pref==='usdt') showUSDT(); else showBank(); });

if(contribClose) contribClose.addEventListener('click', ()=> closeModal(contributeModal));
if(contribCloseX) contribCloseX.addEventListener('click', ()=> closeModal(contributeModal));

/* progress helper */
function updateProgress(percent){
  const p = Math.max(0, Math.min(100, Math.round(percent)));
  if(progressFill) progressFill.style.width = p + '%';
  if(progressPct) progressPct.innerText = p + '%';
  let color = '#e14b4b';
  if(p <= 40) color = '#e14b4b';
  else if(p <= 60) color = '#f6c44b';
  else color = '#34d399';
  if(progressFill) progressFill.style.background = color;
}

/* package selection */
if(packageSelect) packageSelect.addEventListener('change', ()=>{
  const val = packageSelect.value;
  if(!val){
    if(packageAmount) packageAmount.innerText='';
    if(projectName) projectName.innerText='No project selected';
    if(projectMeta) projectMeta.innerText='Choose a package from Contribution';
    if(dreamFunding) dreamFunding.innerText = 'Dream Funding: $0';
    localStorage.removeItem('selectedPackage');
    updateProgress(0);
    if(progressTarget) progressTarget.innerText = 'Target: —';
    return;
  }
  const price = Number(val);
  const pkg = { name: '$' + price, price: price, funding: price * 100 };
  localStorage.setItem('selectedPackage', JSON.stringify(pkg));
  if(projectName) projectName.innerText = pkg.name + ' Package';
  if(projectMeta) projectMeta.innerText = pkg.name + ' • Package selected';
  if(packageAmount) packageAmount.innerText = '(' + pkg.name + ' Contribution)';
  if(dreamFunding) dreamFunding.innerText = 'Dream Funding: $' + numberWithCommas(pkg.funding);
  updateProgress(0);
  if(progressTarget) progressTarget.innerText = 'Target: $' + numberWithCommas(pkg.funding);
});

/* I have paid flow */
if(iPaidBtn) iPaidBtn.addEventListener('click', ()=>{
  if(proofArea) proofArea.style.display='block';
  const pref = localStorage.getItem('preferredContribution') || preferredMethod || 'bank';
  if(pref === 'usdt'){ if(bankProofInputs) bankProofInputs.style.display='none'; if(usdtHashInput) usdtHashInput.style.display='block'; }
  else { if(bankProofInputs) bankProofInputs.style.display='flex'; if(usdtHashInput) usdtHashInput.style.display='none'; }
});
if(proofCloseX) proofCloseX.addEventListener('click', ()=> { if(proofArea) proofArea.style.display='none'; });
if(cancelProof) cancelProof.addEventListener('click', ()=> { if(proofArea) proofArea.style.display='none'; });

/* preview proof */
if(previewProofBtn){
  previewProofBtn.addEventListener('click', ()=>{
    const f = proofFile && proofFile.files && proofFile.files[0];
    if(!f) return showToast('Choose a file first');
    if(filePreview) filePreview.style.display='block';
    if(f.type && f.type.startsWith && f.type.startsWith('image/')){
      const r = new FileReader();
      r.onload = e => { if(filePreviewInner) filePreviewInner.innerHTML = '<img src="'+e.target.result+'" style="max-width:100%;border-radius:8px">'; };
      r.readAsDataURL(f);
    } else {
      if(filePreviewInner) filePreviewInner.innerHTML = '<div style="padding:8px;color:var(--muted)">'+f.name+'</div>';
    }
  });
}
if(previewCloseX) previewCloseX.addEventListener('click', ()=> { if(filePreview) filePreview.style.display='none'; if(filePreviewInner) filePreviewInner.innerHTML=''; });

/* submit proof */
if(submitProof){
  submitProof.addEventListener('click', ()=>{
    const pkg = JSON.parse(localStorage.getItem('selectedPackage') || 'null');
    if(!pkg) return showToast('Choose a package first');
    const pref = localStorage.getItem('preferredContribution') || preferredMethod || 'bank';
    const record = { id: 'PAY-'+Date.now(), package: pkg, method: pref, date: new Date().toISOString(), status: 'pending' };
    if(pref === 'usdt'){
      const hash = txHash && txHash.value && txHash.value.trim();
      if(!hash) return showToast('Paste transaction hash first');
      record.hash = hash;
    } else {
      const f = proofFile && proofFile.files && proofFile.files[0];
      if(!f) return showToast('Upload proof file first');
      record.proofFilename = f.name;
    }
    payments.push(record);
    localStorage.setItem('payments', JSON.stringify(payments));
    // show confirmation inside modal (demo)
    const modal = contributeModal && contributeModal.querySelector('.modal');
    if(modal){
      modal.innerHTML = '<button class="close-x" id="contribCloseConfirm">✕</button><h3>Congratulations (Pending Approval)</h3><p style="color:var(--muted)">Please be patient while we review your payment within 48 hours.</p><div style="margin-top:12px"><button class="btn" id="backToDashboard">Back to dashboard</button></div>';
      setTimeout(()=>{
        const back = getById('backToDashboard');
        const closeConfirm = getById('contribCloseConfirm');
        if(back) back.addEventListener('click', ()=> location.reload());
        if(closeConfirm) closeConfirm.addEventListener('click', ()=> location.reload());
      },80);
    }
    if(proofArea) proofArea.style.display='none';
    if(filePreview) filePreview.style.display='none';
    if(filePreviewInner) filePreviewInner.innerHTML='';
    if(proofFile) proofFile.value='';
    if(txHash) txHash.value='';
    refreshPaymentsNav();
  });
}

/* refresh payments nav */
function refreshPaymentsNav(){
  payments = JSON.parse(localStorage.getItem('payments') || '[]');
  if(paymentsNavPlace) paymentsNavPlace.innerHTML = '';
  if(payments.length>0 && paymentsNavPlace){
    const unCount = payments.filter(p=>p.status==='pending').length;
    const apCount = payments.filter(p=>p.status==='approved').length;
    const btnUn = document.createElement('button'); btnUn.className='menu-item'; btnUn.innerHTML='<span>Unapproved Payments</span><span class="hint">'+unCount+'</span>';
    btnUn.addEventListener('click', ()=> { closeMenu(); openPaymentsList('pending'); });
    const btnAp = document.createElement('button'); btnAp.className='menu-item'; btnAp.innerHTML='<span>Approved Payments</span><span class="hint">'+apCount+'</span>';
    btnAp.addEventListener('click', ()=> { closeMenu(); openPaymentsList('approved'); });
    paymentsNavPlace.appendChild(btnUn); paymentsNavPlace.appendChild(btnAp);
  }
}

/* open payments list modal */
function openPaymentsList(status){
  payments = JSON.parse(localStorage.getItem('payments') || '[]');
  if(!paymentsListArea) return;
  paymentsListArea.innerHTML = '';
  const list = payments.filter(p=>p.status===status);
  if(list.length===0){ paymentsListArea.innerHTML = '<div style="color:var(--muted)">No payments '+status+'</div>'; openModal(paymentsModal); return; }
  list.forEach(p=>{
    const d = document.createElement('div'); d.style.padding='10px'; d.style.background='rgba(0,0,0,0.02)'; d.style.borderRadius='8px'; d.style.marginTop='8px';
    d.innerHTML = '<div style="font-weight:800">'+p.package.name+' • $'+p.package.price+'</div><div style="font-size:13px;color:var(--muted)">' + 'Dream Funding: $' + numberWithCommas(p.package.funding) + ' • ' + (p.method==='usdt'?'USDT':'Bank')+' • '+new Date(p.date).toLocaleString() + '</div>';
    if(p.status==='pending'){
      const stat = document.createElement('div'); stat.style.marginTop='8px'; stat.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--danger);margin-right:8px"></span><span>Yet to be approved</span>';
      d.appendChild(stat);
      const simWrap = document.createElement('div'); simWrap.style.marginTop='8px';
      const approveBtn = document.createElement('button'); approveBtn.className='btn'; approveBtn.innerText='Simulate Approve (Demo)';
      approveBtn.addEventListener('click', ()=>{
        p.status='approved';
        payments = payments.map(x=> x.id===p.id? p : x);
        localStorage.setItem('payments', JSON.stringify(payments));
        projects.push({ id:'PRJ-'+Date.now(), name:p.package.name, amount:p.package.price, funding: p.package.funding, status:'Active' });
        localStorage.setItem('projects', JSON.stringify(projects));
        const refs = parseInt(localStorage.getItem('referrals')||'0',10) + 1;
        localStorage.setItem('referrals', refs.toString());
        refreshPaymentsNav(); renderProjects(); updateReferralsUI();
        showToast('Payment approved (demo).');
        openPaymentsList('approved');
      });
      simWrap.appendChild(approveBtn); d.appendChild(simWrap);
    } else {
      const stat = document.createElement('div'); stat.style.marginTop='8px'; stat.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#34d399;box-shadow:0 0 6px rgba(52,211,153,0.35);margin-right:8px"></span><span>Approved and active</span>';
      d.appendChild(stat);
      const viewBtn = document.createElement('button'); viewBtn.className='btn ghost'; viewBtn.style.marginTop='8px'; viewBtn.innerText='View in Projects';
      viewBtn.addEventListener('click', ()=> { closeModal(paymentsModal); renderProjects(); openModal(projectsModal); });
      d.appendChild(viewBtn);
    }
    paymentsListArea.appendChild(d);
  });
  openModal(paymentsModal);
}

/* ---------- Projects ---------- */
function renderProjects(){
  projects = JSON.parse(localStorage.getItem('projects') || '[]');
  if(!projectsList) return;
  projectsList.innerHTML = '';
  if(!projects || projects.length===0){ projectsList.innerHTML = '<div style="color:var(--muted)">No projects yet.</div>'; if(getById('activeProjectsCount')) getById('activeProjectsCount').innerText = 0; return; }
  projects.forEach(p=>{
    const div = document.createElement('div');
    div.className='project-item';
    div.style.marginTop='8px';
    div.style.padding='10px';
    div.style.background='rgba(0,0,0,0.02)';
    div.innerHTML = '<div style="font-weight:800">'+p.name+'</div><div style="font-size:13px;color:var(--muted)">ID: '+p.id+' • Contribution: $'+ numberWithCommas(p.amount) +' • Dream Funding: $'+ numberWithCommas(p.funding) +' • '+p.status+'</div>';
    projectsList.appendChild(div);
  });
  if(getById('activeProjectsCount')) getById('activeProjectsCount').innerText = projects.length;
}

/* ---------- Edit Profile upload (safe) ---------- */
let pendingImageData = null;
if(profileImageFile) profileImageFile.addEventListener('change', ()=>{
  const f = profileImageFile.files[0];
  if(!f) return showToast('Choose an image');
  if(!f.type.startsWith('image/')) return showToast('Image required');
  const r = new FileReader();
  r.onload = e => {
    pendingImageData = e.target.result;
    if(profilePreview) profilePreview.innerHTML = '<img src="'+pendingImageData+'" style="width:100%;height:100%;object-fit:cover">';
  };
  r.readAsDataURL(f);
});
if(editCancel) editCancel.addEventListener('click', ()=> { closeModal(editProfileModal); pendingImageData=null; if(profileImageFile) profileImageFile.value=''; if(profilePreview) profilePreview.innerHTML='No image'; });
if(editCloseX) editCloseX.addEventListener('click', ()=> { closeModal(editProfileModal); pendingImageData=null; if(profileImageFile) profileImageFile.value=''; if(profilePreview) profilePreview.innerHTML='No image'; });

if(saveProfileBtn) saveProfileBtn.addEventListener('click', ()=>{
  const pwd = newPassword ? newPassword.value.trim() : '';
  const nameVal = editName ? editName.value.trim() : '';
  if(pendingImageData){
    safeSetProfileImage(pendingImageData);
    pendingImageData = null;
    if(profileImageFile) profileImageFile.value = '';
    if(profilePreview) profilePreview.innerHTML = 'No image';
  }
  let user = JSON.parse(localStorage.getItem('user') || '{}');
  if(nameVal){
    user.name = nameVal;
    if(getById('welcomeTitle')) getById('welcomeTitle').innerText = translations[getLang()].welcome + user.name;
    if(getById('menuName')) getById('menuName').innerText = user.name;
    setInitialsFromName(user.name);
  }
  if(pwd){
    user.password = pwd;
    if(newPassword) newPassword.value = '';
    showToast('Password saved (demo)');
  }
  localStorage.setItem('user', JSON.stringify(user));
  showToast('Profile updated');
  closeModal(editProfileModal);
});

/* ---------- Settings modal behavior (NEW) ---------- */
if(settingsUploadBtn) settingsUploadBtn.addEventListener('click', ()=> settingsImageFile.click());
if(settingsImageFile) settingsImageFile.addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return showToast('Choose an image');
  if(!f.type.startsWith('image/')) return showToast('Image required');
  const r = new FileReader();
  r.onload = e => {
    pendingSettingsImage = e.target.result;
    if(settingsPreview) settingsPreview.innerHTML = '<img src="'+pendingSettingsImage+'" style="width:100%;height:100%;object-fit:cover">';
  };
  r.readAsDataURL(f);
});
let pendingSettingsImage = null;

if(toggle2faBtn) toggle2faBtn.addEventListener('click', ()=>{
  const enabled = localStorage.getItem('2faEnabled') === 'true';
  if(!enabled){
    const secret = 'DBP-' + Math.random().toString(36).slice(2,10).toUpperCase();
    localStorage.setItem('2faEnabled','true'); localStorage.setItem('2faSecret', secret);
    if(twoFaSecret) twoFaSecret.innerText = secret;
    const qrSrc = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent('otpauth://totp/DreamBig?secret='+secret);
    if(twoFaQRCode) twoFaQRCode.innerHTML = '<img src="'+qrSrc+'" style="width:100%;height:100%;object-fit:cover">';
    if(twoFaArea) twoFaArea.style.display = 'flex';
    if(toggle2faBtn) toggle2faBtn.innerText = 'Disconnect 2FA';
    showToast('2FA connected (demo)');
  } else {
    localStorage.removeItem('2faEnabled'); localStorage.removeItem('2faSecret');
    if(twoFaArea) twoFaArea.style.display = 'none';
    if(toggle2faBtn) toggle2faBtn.innerText = 'Connect 2FA';
    showToast('2FA disconnected (demo)');
  }
});
if(copy2faSecret) copy2faSecret.addEventListener('click', ()=> { const s = localStorage.getItem('2faSecret'); if(s) copyText(s); else showToast('No secret'); });

if(settingsCancel) settingsCancel.addEventListener('click', ()=> closeModal(settingsModal));
if(settingsCloseX) settingsCloseX.addEventListener('click', ()=> closeModal(settingsModal));

if(settingsSave) settingsSave.addEventListener('click', ()=>{
  const nameVal = settingsName ? settingsName.value.trim() : '';
  const pwdVal = settingsPassword ? settingsPassword.value.trim() : '';
  const lang = langSelect ? langSelect.value : 'en';
  const theme = themeSelect ? themeSelect.value : 'light';
  if(pendingSettingsImage){
    safeSetProfileImage(pendingSettingsImage);
    if(settingsPreview) settingsPreview.innerHTML = 'No image';
    pendingSettingsImage = null;
    if(settingsImageFile) settingsImageFile.value = '';
  }
  let user = JSON.parse(localStorage.getItem('user') || '{}');
  if(nameVal){
    user.name = nameVal;
    if(getById('welcomeTitle')) getById('welcomeTitle').innerText = translations[getLang()].welcome + user.name;
    if(getById('menuName')) getById('menuName').innerText = user.name;
    setInitialsFromName(user.name);
  }
  if(pwdVal){ user.password = pwdVal; showToast('Password saved (demo)'); }
  localStorage.setItem('user', JSON.stringify(user));
  localStorage.setItem('lang', lang);
  applyTranslations();
  localStorage.setItem('theme', theme);
  applyTheme();
  showToast('Settings saved');
  closeModal(settingsModal);
});

/* ---------- Copy btns ---------- */
document.querySelectorAll('.copy-btn').forEach(btn=> btn.addEventListener('click', (e)=> {
  const key = e.currentTarget.getAttribute('data-copy');
  if(key === 'bankAcct') copyText(getById('bankAcct').innerText.trim());
  if(key === 'walletAddr') copyText(getById('walletAddr').innerText.trim());
}));

/* ---------- QR ---------- */
if(getById('showQR')){
  getById('showQR').addEventListener('click', ()=>{
    const addr = getById('walletAddr').innerText.trim();
    const src = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(addr);
    if(qrImage) qrImage.innerHTML = '<img src="'+src+'" style="width:100%;height:100%;object-fit:cover">';
    closeModal(contributeModal); openModal(qrModal);
  });
}
if(qrClose) qrClose.addEventListener('click', ()=> closeModal(qrModal));
if(qrCloseX) qrCloseX.addEventListener('click', ()=> closeModal(qrModal));

/* ---------- Payments & Projects controls ---------- */
if(paymentsClose) paymentsClose.addEventListener('click', ()=> closeModal(paymentsModal));
if(paymentsCloseX) paymentsCloseX.addEventListener('click', ()=> closeModal(paymentsModal));
if(projectsClose) projectsClose.addEventListener('click', ()=> closeModal(projectsModal));
if(projectsCloseX) projectsCloseX.addEventListener('click', ()=> closeModal(projectsModal));

/* ---------- Logout ---------- */
if(btnNo) btnNo.addEventListener('click', ()=> closeModal(logoutModal));
if(btnYes) btnYes.addEventListener('click', ()=> { closeModal(logoutModal); getById('appRoot').style.opacity = '0.25'; setTimeout(()=> location.href = 'login.html', 900); });
if(getById('mLogout')) getById('mLogout').addEventListener('click', ()=> { closeMenu(); openModal(logoutModal); });

/* ---------- Withdraw handler ---------- */
if(mWithdraw) mWithdraw.addEventListener('click', ()=> { closeMenu(); window.location.href = 'withdraw.html'; });

/* ---------- Sharing ---------- */
if(shareHere) shareHere.addEventListener('click', async ()=>{
  const url = location.href; const lang = getLang();
  const obj = { title: translations[lang].shareText, text: translations[lang].shareText, url };
  if(navigator.share){ try{ await navigator.share(obj); } catch(e){} } else if(navigator.clipboard){ navigator.clipboard.writeText(url).then(()=> showToast('Referral copied')); } else showToast('Copy: '+url);
});

/* ---------- Settings open helper ---------- */
function openSettings(){
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  if(settingsName) settingsName.value = user.name || '';
  if(settingsPassword) settingsPassword.value = '';
  const img = localStorage.getItem('profileImage');
  if(img && settingsPreview) settingsPreview.innerHTML = '<img src="'+img+'" style="width:100%;height:100%;object-fit:cover">';
  else if(settingsPreview) settingsPreview.innerHTML = 'No image';
  const lang = localStorage.getItem('lang') || 'en';
  if(langSelect) langSelect.value = lang;
  const theme = localStorage.getItem('theme') || 'light';
  if(themeSelect) themeSelect.value = theme;
  const twofa = localStorage.getItem('2faEnabled') === 'true';
  if(toggle2faBtn) toggle2faBtn.innerText = twofa ? 'Disconnect 2FA' : 'Connect 2FA';
  if(twofa){
    const secret = localStorage.getItem('2faSecret') || '';
    if(twoFaSecret) twoFaSecret.innerText = secret;
    const qrSrc = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent('otpauth://totp/DreamBig?secret='+secret);
    if(twoFaQRCode) twoFaQRCode.innerHTML = '<img src="'+qrSrc+'" style="width:100%;height:100%;object-fit:cover">';
    if(twoFaArea) twoFaArea.style.display = 'flex';
  } else if(twoFaArea) twoFaArea.style.display = 'none';
  openModal(settingsModal);
}

/* ---------- Translations and Theme ---------- */
function getLang(){ return localStorage.getItem('lang') || 'en'; }
function applyTranslations(){
  const lang = getLang();
  if(getById('dashboardTitle')) getById('dashboardTitle').innerText = translations[lang].dashboard;
  if(getById('kpiActiveLabel')) getById('kpiActiveLabel').innerText = translations[lang].activeProjects;
  if(getById('kpiContributionLabel')) getById('kpiContributionLabel').innerText = translations[lang].totalContribution;
  if(getById('kpiReferralsLabel')) getById('kpiReferralsLabel').innerText = translations[lang].referrals;
  if(getById('referralHint')) getById('referralHint').innerText = translations[lang].referralsHint;
  if(getById('contribLabel')) getById('contribLabel').innerText = translations[lang].contribution;
  if(getById('welcomeTitle')) getById('welcomeTitle').innerText = translations[lang].welcome + (JSON.parse(localStorage.getItem('user')||'{}').name || 'Member');
  if(getById('referralsTitle')) getById('referralsTitle').innerText = translations[lang].referralsTitle;
}
function applyTheme(){
  const theme = localStorage.getItem('theme') || 'light';
  if(theme === 'navy') document.documentElement.classList.add('theme-navy');
  else document.documentElement.classList.remove('theme-navy');
}

/* ---------- Menu header view/hide ---------- */
if(menuViewToggle) menuViewToggle.addEventListener('click', ()=>{
  const hidden = menuName.style.visibility === 'hidden';
  if(hidden){ menuName.style.visibility = 'visible'; menuViewToggle.innerText = 'Hide'; } else { menuName.style.visibility = 'hidden'; menuViewToggle.innerText = 'View'; }
});

/* ---------- Init UI state ---------- */
function updateReferralsUI(){
  const refs = parseInt(localStorage.getItem('referrals')||'0',10);
  if(getById('refersNum')) getById('refersNum').innerText = refs;
}
function init(){
  const meta = getById('metaDate');
  if(meta && !meta.innerText) { const d=new Date(); meta.innerText = (d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear(); }
  const savedImg = localStorage.getItem('profileImage');
  if(savedImg){
    if(profileImg){ profileImg.src = savedImg; profileImg.style.display='block'; }
    if(profileInitials) profileInitials.style.display='none';
    if(dbLogo) dbLogo.innerHTML = '<img src="'+savedImg+'">';
    if(menuThumb) menuThumb.innerHTML = '<img src="'+savedImg+'" style="width:100%;height:100%;object-fit:cover">';
  }
  const pkg = JSON.parse(localStorage.getItem('selectedPackage') || 'null');
  if(pkg){
    if(projectName) projectName.innerText = pkg.name + ' Package';
    if(projectMeta) projectMeta.innerText = pkg.name + ' • Package selected';
    if(packageAmount) packageAmount.innerText = '(' + pkg.name + ' Contribution)';
    if(dreamFunding) dreamFunding.innerText = 'Dream Funding: $' + numberWithCommas(pkg.funding);
    if(progressTarget) progressTarget.innerText = 'Target: $' + numberWithCommas(pkg.funding);
    const savedPct = Number(localStorage.getItem('progressPercent') || '0');
    updateProgress(savedPct);
  } else {
    updateProgress(0);
  }
  refreshPaymentsNav(); renderProjects(); updateReferralsUI(); applyTranslations(); applyTheme();
  initTypedBanner(); // start typed banner (3s delay inside)
}
init();

/* ---------- copy actions ---------- */
document.querySelectorAll('.copy-btn').forEach(btn=>{
  btn.addEventListener('click', e=>{
    const key = btn.getAttribute('data-copy');
    if(key === 'bankAcct') copyText(getById('bankAcct').innerText.trim());
    if(key === 'walletAddr') copyText(getById('walletAddr').innerText.trim());
  });
});

/* ---------- menu close on ESC ---------- */
document.addEventListener('keyup', (e)=> { if(e.key === 'Escape') { closeMenu(); closeModal(settingsModal); closeModal(editProfileModal); closeModal(contributeModal); } });

/* ---------- profile menu quick bindings ---------- */
if(getById('profileLogoutBtn')) getById('profileLogoutBtn').addEventListener('click', ()=> { closeMenu(); openModal(logoutModal); });

/* ---------- expose openSettings for debug/demo ---------- */
window.openSettings = openSettings;

/* ---------- TYPED BANNER LOGIC (single run, starts 3s after page load) ---------- */
function initTypedBanner(){
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const typedSmall = getById('typedSmall');
  const typedMain = getById('typedMain');
  const bannerCaret = getById('bannerCaret');
  if(!typedMain) return;
  const mainText = 'MAKE IT HAPPEN . SHOCK THE WORLD';
  const typeSpeed = 60;
  if(prefersReduced){
    if(typedSmall) typedSmall.textContent = '';
    typedMain.textContent = mainText;
    if(bannerCaret) bannerCaret.style.display = 'none';
    return;
  }
  if(typedSmall) typedSmall.textContent = '';
  // start typing once after 3 seconds
  setTimeout(() => {
    let i = 0;
    if(bannerCaret) bannerCaret.style.display = 'inline-block';
    typedMain.textContent = '';
    const t = setInterval(() => {
      typedMain.textContent += mainText.charAt(i);
      i++;
      if(i >= mainText.length){
        clearInterval(t);
        if(bannerCaret) setTimeout(()=> bannerCaret.style.display = 'none', 500);
      }
    }, typeSpeed);
  }, 3000);
}
</script>
</body>
</html>
