<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Dream Big — Dashboard</title>
<meta name="theme-color" content="#071a2a"/>
<style>
  :root{
    --bg:#061228; --card:#0f2a44; --muted:#9fb3c7; --accent:#f6c44b; --danger:#e14b4b; --text:#eaf6ff;
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#021226 0%, #071a2a 100%);color:var(--text)}
  .app{min-height:100vh;display:flex;flex-direction:column;padding:16px;gap:12px;transition:opacity .45s}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;z-index:50}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#042137;font-weight:800;font-size:16px;overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:cover;border-radius:8px}
  .title{font-size:16px;font-weight:700}
  .meta{font-size:12px;color:var(--muted)}
  .menu-btn{width:46px;height:46px;border-radius:12px;background:var(--card);display:flex;align-items:center;justify-content:center;border:none;color:var(--muted);font-weight:800;font-size:20px}
  .overlay-dim{position:fixed;inset:0;background:rgba(0,0,0,0.45);opacity:0;pointer-events:none;transition:opacity 220ms ease;z-index:45}
  .overlay-dim.visible{opacity:1;pointer-events:auto}
  .menu-panel{position:fixed;top:72px;right:12px;width:92%;max-width:360px;background:linear-gradient(180deg,#072235,#0f2a44);border-radius:14px;padding:10px;box-shadow:0 20px 60px rgba(0,0,0,0.6);transform-origin:top right;opacity:0;pointer-events:none;transform:translateY(-8px) scale(.98);transition:all 220ms cubic-bezier(.2,.9,.2,1);z-index:48}
  .menu-panel.open{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}
  .menu-item{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:10px;color:var(--muted);background:transparent;border:none;width:100%;text-align:left;font-weight:700;font-size:15px}
  .menu-item:hover{background:rgba(255,255,255,0.02);color:var(--text)}
  .menu-item .hint{font-size:12px;color:var(--muted);font-weight:600}
  .profile{width:40px;height:40px;border-radius:50%;background:linear-gradient(180deg,#16394f,#0f2a44);display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;overflow:hidden;position:relative}
  .profile img{width:100%;height:100%;object-fit:cover;border-radius:50%}
  .profile-initials{font-weight:800;color:var(--muted)}
  main{flex:1;overflow:auto;padding-bottom:110px}
  .welcome{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:16px}
  .kpis{display:flex;gap:8px;margin-top:12px}
  .kpi{flex:1;padding:10px;background:var(--card);border-radius:12px;text-align:left}
  .kpi .num{font-size:18px;font-weight:800}
  .card{background:var(--card);padding:14px;border-radius:16px;margin-top:14px}
  .form-row{display:flex;gap:8px;margin-top:12px}
  .input,select{flex:1;padding:10px;border-radius:10px;border:none;background:rgba(255,255,255,0.02);color:var(--muted);font-size:14px}
  .submit{background:var(--accent);color:#042137;padding:10px 14px;border-radius:10px;border:none;font-weight:700}
  /* Footer: gold separator + simple copyright */
  footer{position:fixed;left:12px;right:12px;bottom:12px;background:linear-gradient(90deg,#071a2a,#072434);padding:12px;border-radius:12px;display:flex;align-items:center;box-shadow:0 8px 30px rgba(0,0,0,0.4);z-index:40;border-top:4px solid var(--accent);justify-content:center}
  .btn{padding:10px 12px;border-radius:10px;border:none}
  .btn.ghost{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}
  .btn.warn{background:var(--danger);color:white}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:46}
  .modal{background:linear-gradient(180deg,#072235,#0f2a44);padding:18px;border-radius:12px;min-width:280px;box-shadow:0 8px 30px rgba(0,0,0,0.6);position:relative}
  .modal h3{margin:0 0 6px 0}
  .modal p{color:var(--muted);margin:0 0 12px 0}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end}
  .close-x{position:absolute;right:12px;top:10px;background:transparent;border:none;color:var(--danger);font-weight:900;font-size:20px;border-radius:6px;padding:6px}
  .proof-area{margin-top:12px;background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
  .file-preview{margin-top:8px;background:rgba(0,0,0,0.2);padding:8px;border-radius:8px}
  .profile-menu{position:absolute;top:62px;right:12px;background:var(--card);padding:8px;border-radius:10px;min-width:160px;display:none;box-shadow:0 8px 30px rgba(0,0,0,0.5);z-index:50}
  .profile-menu button{display:block;width:100%;text-align:left;padding:10px;border-radius:8px;border:none;background:transparent;color:var(--text);font-weight:700}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:110px;background:rgba(0,0,0,0.75);color:#fff;padding:10px 14px;border-radius:10px;display:none;z-index:80;font-weight:700}
  @media(min-width:540px){.app{padding:20px}}
</style>
</head>
<body>
  <div class="app" id="appRoot">

    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="logo" id="dbLogo">
          <!-- logo image inserted here if profile image saved -->
        </div>
        <div>
          <div class="title">Dashboard</div>
          <div class="meta" id="metaDate"></div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <button class="menu-btn" id="menuBtn" aria-label="Open menu">☰</button>

        <!-- profile circle with img element (keeps handlers safe) -->
        <div class="profile" id="profileCircle" title="Profile">
          <img id="profileImg" alt="Profile" style="display:none">
          <span id="profileInitials" class="profile-initials">PD</span>

          <div class="profile-menu" id="profileMenu" role="menu" aria-hidden="true">
            <button id="viewProfileBtn">View Profile</button>
            <button id="editProfileBtn">Edit Profile</button>
            <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:8px 0">
            <button id="profileLogoutBtn" style="color:var(--danger)">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <div class="overlay-dim" id="overlayDim" tabindex="-1"></div>

    <!-- MENU PANEL -->
    <div class="menu-panel" id="menuPanel" aria-hidden="true">
      <button class="menu-item" id="mTiers">Member Tiers<span class="hint">Upgrade</span></button>
      <button class="menu-item" id="mViewProjects">View Projects<span class="hint">Your projects</span></button>
      <button class="menu-item" id="mContribute"><span id="contribLabel">Contribution</span><span class="hint" id="contribHint">Contribution</span></button>
      <button class="menu-item" id="mHelp">Help & Support<span class="hint">Contact</span></button>
      <div id="paymentsNavPlace"></div>
      <button class="menu-item" id="mSettings">Settings<span class="hint">Preferences</span></button>
      <button class="menu-item" id="mLogout">Logout<span class="hint">Sign out</span></button>
    </div>

    <main>
      <section class="welcome">
        <h2 id="welcomeTitle">Welcome, Member</h2>
        <div class="kpis">
          <div class="kpi"><div class="num" id="activeProjectsCount">0</div><div style="font-size:12px;color:var(--muted)">Active Projects</div></div>
          <div class="kpi"><div class="num" id="totalContribution">$0</div><div style="font-size:12px;color:var(--muted)">Total Contribution</div></div>
          <div class="kpi"><div class="num" id="refersNum">0</div><div style="font-size:12px;color:var(--muted)">Referrals</div></div>
        </div>
      </section>

      <article class="card">
        <div class="project-title">
          <div>
            <div style="font-weight:800" id="projectName">No project selected</div>
            <div style="font-size:12px;color:var(--muted)" id="projectMeta">Choose a package from Contribution</div>
          </div>
          <div style="text-align:right;color:var(--muted)"><div style="font-weight:800" id="packageAmount"></div></div>
        </div>

        <div style="display:flex;justify-content:space-between;margin-top:10px;color:var(--muted);font-size:13px">
          <div id="progressPct">0%</div>
          <div id="progressTarget">Target: $0</div>
        </div>
      </article>

      <section class="card">
        <div style="font-weight:800">Referrals</div>
        <div style="margin-top:8px;color:var(--muted);font-size:13px">Referrals are counted only after payments are approved by admin.</div>
        <div style="margin-top:10px"><button class="btn ghost" id="shareHere">Share Referral Link</button></div>
      </section>

    </main>

    <footer>
      <div style="font-size:13px">© 2026 Dream Big Project — All rights reserved.</div>
    </footer>

    <div class="toast" id="toast">Copied!</div>

    <!-- ========== MODALS ========== -->

    <!-- Contribution modal -->
    <div class="modal-backdrop" id="contributeModal">
      <div class="modal" role="document">
        <button class="close-x" id="contribCloseX" title="Close">✕</button>
        <h3>Contribute</h3>
        <p>Choose a package, then select payment method (Bank or USDT TRC20). After payment, submit proof or paste TX hash.</p>

        <div style="margin-top:10px">
          <select class="input" id="packageSelect">
            <option value="">-- Select Package --</option>
            <option value='{"name":"Starter","price":25}'>Starter ($25)</option>
            <option value='{"name":"Spark","price":100}'>Spark ($100)</option>
            <option value='{"name":"Growth","price":250}'>Growth ($250)</option>
          </select>
        </div>

        <div style="margin-top:10px">
          <button class="btn ghost" id="methodBank">Bank Deposit</button>
          <button class="btn ghost" id="methodUSDT">USDT (TRC20)</button>
        </div>

        <div id="bankBlock" style="margin-top:12px;display:none">
          <div class="copy"><span class="label">Bank: FIRST NATIONAL BANK</span>
            <div>Account Name: DREAM BIG PROJECT</div>
            <div>Account Number: <strong id="bankAcct">0123456789</strong></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost copy-btn" data-copy="bankAcct">Copy Account</button>
          </div>
        </div>

        <div id="usdtBlock" style="margin-top:12px;display:none">
          <div class="copy"><span class="label">TRC20 Wallet (USDT)</span>
            <div id="walletAddr" style="word-break:break-all"><strong>TXxExampleWalletAddress1234567890abcdef</strong></div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn ghost copy-btn" data-copy="walletAddr">Copy Wallet</button>
            <button class="btn ghost" id="showQR">Show QR</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <button class="btn" id="iPaidBtn">I have paid</button>
        </div>

        <!-- Proof area (shows after I have paid) -->
        <div class="proof-area" id="proofArea" style="display:none">
          <button class="close-x" id="proofCloseX" title="Close">✕</button>
          <div style="font-weight:800" id="proofTitle">Upload proof or paste TX hash</div>
          <div style="font-size:13px;color:var(--muted);margin-top:6px" id="proofHint">Bank: upload image/PDF. USDT: paste transaction hash.</div>

          <div id="bankProofInputs" style="margin-top:8px;display:none">
            <div style="display:flex;gap:8px;align-items:center">
              <input type="file" id="proofFile" accept="image/*,.pdf">
              <button class="btn ghost" id="previewProof">Preview</button>
            </div>
            <div class="file-preview" id="filePreview" style="display:none;position:relative">
              <button class="close-x" id="previewCloseX" title="Close">✕</button>
              <div id="filePreviewInner"></div>
            </div>
          </div>

          <div id="usdtHashInput" style="margin-top:8px;display:none">
            <input class="input" id="txHash" placeholder="Paste transaction hash here">
            <div style="margin-top:8px;font-size:12px;color:var(--muted)">Be sure the TX is confirmed on TRON network.</div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="cancelProof">Cancel</button>
            <button class="btn" id="submitProof">Submit</button>
          </div>
        </div>

        <div class="actions" style="margin-top:14px">
          <button class="btn ghost" id="contribClose">Close</button>
        </div>
      </div>
    </div>

    <!-- Edit Profile modal -->
    <div class="modal-backdrop" id="editProfileModal">
      <div class="modal">
        <button class="close-x" id="editCloseX">✕</button>
        <h3>Edit Profile</h3>
        <p style="color:var(--muted)">Upload a facial image and change password (email not editable here).</p>

        <div style="margin-top:8px">
          <input type="file" id="profileImageFile" accept="image/*">
        </div>
        <div style="margin-top:10px">
          <div id="profilePreview" style="width:120px;height:120px;border-radius:8px;overflow:hidden;background:rgba(0,0,0,0.1);display:grid;place-items:center">No image</div>
        </div>

        <div style="margin-top:10px">
          <input class="input" id="newPassword" placeholder="New password" type="password">
        </div>

        <div class="actions" style="margin-top:12px">
          <button class="btn ghost" id="editCancel">Cancel</button>
          <button class="btn" id="saveProfileBtn">Save</button>
        </div>
      </div>
    </div>

    <!-- Payments modal (Unapproved / Approved list) -->
    <div class="modal-backdrop" id="paymentsModal">
      <div class="modal">
        <button class="close-x" id="paymentsCloseX">✕</button>
        <h3 id="paymentsTitle">Payments</h3>
        <div id="paymentsListArea" style="margin-top:10px"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="paymentsClose">Close</button></div>
      </div>
    </div>

    <!-- Projects modal -->
    <div class="modal-backdrop" id="projectsModal">
      <div class="modal">
        <button class="close-x" id="projectsCloseX">✕</button>
        <h3>Your Projects</h3>
        <div class="projects-list" id="projectsList" style="margin-top:10px"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="projectsClose">Close</button></div>
      </div>
    </div>

    <!-- Simple logout confirm modal -->
    <div class="modal-backdrop" id="logoutModal">
      <div class="modal">
        <h3>Confirm Logout</h3>
        <p>Are you sure you want to log out?</p>
        <div class="actions">
          <button class="btn ghost" id="btnNo">No</button>
          <button class="btn warn" id="btnYes">Yes</button>
        </div>
      </div>
    </div>

    <!-- QR modal -->
    <div class="modal-backdrop" id="qrModal">
      <div class="modal" style="text-align:center">
        <button class="close-x" id="qrCloseX">✕</button>
        <h3>USDT (TRC20) QR</h3>
        <div id="qrImage" style="margin:12px auto;width:220px;height:220px;border-radius:12px;overflow:hidden;background:#fff;display:grid;place-items:center"></div>
        <div class="actions" style="margin-top:12px"><button class="btn ghost" id="qrClose">Close</button></div>
      </div>
    </div>

  </div>

<script>
/* ---------- Refs ---------- */
const menuBtn = document.getElementById('menuBtn');
const menuPanel = document.getElementById('menuPanel');
const overlayDim = document.getElementById('overlayDim');
const mContribute = document.getElementById('mContribute');
const mViewProjects = document.getElementById('mViewProjects');
const mTiers = document.getElementById('mTiers');
const mHelp = document.getElementById('mHelp');
const mSettings = document.getElementById('mSettings');
const mLogout = document.getElementById('mLogout');
const paymentsNavPlace = document.getElementById('paymentsNavPlace');

const profileCircle = document.getElementById('profileCircle');
const profileImg = document.getElementById('profileImg');
const profileInitials = document.getElementById('profileInitials');
const profileMenu = document.getElementById('profileMenu');
const viewProfileBtn = document.getElementById('viewProfileBtn');
const editProfileBtn = document.getElementById('editProfileBtn');
const profileLogoutBtn = document.getElementById('profileLogoutBtn');

const contributeModal = document.getElementById('contributeModal');
const contribClose = document.getElementById('contribClose');
const contribCloseX = document.getElementById('contribCloseX');
const methodBankBtn = document.getElementById('methodBank');
const methodUSDTBtn = document.getElementById('methodUSDT');
const bankBlock = document.getElementById('bankBlock');
const usdtBlock = document.getElementById('usdtBlock');
const iPaidBtn = document.getElementById('iPaidBtn');
const proofArea = document.getElementById('proofArea');
const proofCloseX = document.getElementById('proofCloseX');
const bankProofInputs = document.getElementById('bankProofInputs');
const usdtHashInput = document.getElementById('usdtHashInput');
const proofFile = document.getElementById('proofFile');
const previewProofBtn = document.getElementById('previewProof');
const filePreview = document.getElementById('filePreview');
const filePreviewInner = document.getElementById('filePreviewInner');
const previewCloseX = document.getElementById('previewCloseX');
const cancelProof = document.getElementById('cancelProof');
const submitProof = document.getElementById('submitProof');
const txHash = document.getElementById('txHash');

const packageSelect = document.getElementById('packageSelect');
const packageAmount = document.getElementById('packageAmount');
const projectName = document.getElementById('projectName');
const projectMeta = document.getElementById('projectMeta');
const progressPct = document.getElementById('progressPct');
const progressTarget = document.getElementById('progressTarget');

const editProfileModal = document.getElementById('editProfileModal');
const profileImageFile = document.getElementById('profileImageFile');
const profilePreview = document.getElementById('profilePreview');
const newPassword = document.getElementById('newPassword');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const editCancel = document.getElementById('editCancel');
const editCloseX = document.getElementById('editCloseX');

const paymentsModal = document.getElementById('paymentsModal');
const paymentsListArea = document.getElementById('paymentsListArea');
const paymentsClose = document.getElementById('paymentsClose');
const paymentsCloseX = document.getElementById('paymentsCloseX');

const projectsModal = document.getElementById('projectsModal');
const projectsList = document.getElementById('projectsList');
const projectsClose = document.getElementById('projectsClose');

const logoutModal = document.getElementById('logoutModal');
const btnNo = document.getElementById('btnNo'), btnYes = document.getElementById('btnYes');

const qrModal = document.getElementById('qrModal'), qrImage = document.getElementById('qrImage'), qrClose = document.getElementById('qrClose'), qrCloseX = document.getElementById('qrCloseX');

const dbLogo = document.getElementById('dbLogo');
const toast = document.getElementById('toast');
const copyButtons = document.querySelectorAll('.copy-btn');
const shareHere = document.getElementById('shareHere');

let payments = JSON.parse(localStorage.getItem('payments') || '[]');
let projects = JSON.parse(localStorage.getItem('projects') || '[]');

/* ---------- Utilities ---------- */
function showToast(msg){ toast.innerText = msg || 'Copied!'; toast.style.display='block'; toast.style.opacity='1'; setTimeout(()=>{ toast.style.transition='opacity 300ms ease'; toast.style.opacity='0'; setTimeout(()=>{ toast.style.display='none'; toast.style.transition=''; },300); },1400); }
function copyText(text){ if(!text) return showToast('Nothing to copy'); if(navigator.clipboard){ navigator.clipboard.writeText(text).then(()=> showToast('Copied')); } else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand('copy'); showToast('Copied'); } catch(e){ showToast('Copy failed'); } ta.remove(); } }
function openModal(el){ if(!el) return; el.style.display='flex'; el.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function closeModal(el){ if(!el) return; el.style.display='none'; el.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }

/* ---------- Menu ---------- */
function openMenu(){ menuPanel.classList.add('open'); overlayDim.classList.add('visible'); menuPanel.setAttribute('aria-hidden','false'); setTimeout(()=>document.addEventListener('click', docClickCloseMenu),20); }
function closeMenu(){ menuPanel.classList.remove('open'); overlayDim.classList.remove('visible'); menuPanel.setAttribute('aria-hidden','true'); document.removeEventListener('click', docClickCloseMenu); }
function docClickCloseMenu(e){ if(!menuPanel.contains(e.target) && !menuBtn.contains(e.target)) closeMenu(); }
menuBtn.addEventListener('click',(e)=>{ e.stopPropagation(); menuPanel.classList.contains('open')? closeMenu() : openMenu(); });
overlayDim.addEventListener('click', ()=> closeMenu());

/* ---------- Profile menu ---------- */
profileCircle.addEventListener('click',(e)=>{
  e.stopPropagation();
  const open = profileMenu.style.display === 'block';
  profileMenu.style.display = open ? 'none' : 'block';
  profileMenu.setAttribute('aria-hidden', open ? 'true' : 'false');
});
document.addEventListener('click',(e)=>{
  if(profileMenu.style.display === 'block' && !profileCircle.contains(e.target)){
    profileMenu.style.display='none'; profileMenu.setAttribute('aria-hidden','true');
  }
});
viewProfileBtn.addEventListener('click', ()=>{ profileMenu.style.display='none'; alert('Profile view (demo)'); });
editProfileBtn.addEventListener('click', ()=>{ profileMenu.style.display='none'; openModal(editProfileModal); });
profileLogoutBtn.addEventListener('click', ()=>{ profileMenu.style.display='none'; openModal(logoutModal); });

/* ---------- Init user & profile image ---------- */
function safeSetProfileImage(dataUrl){
  // set src on existing img element and show it; hide initials
  if(!dataUrl) return;
  profileImg.src = dataUrl;
  profileImg.style.display = 'block';
  profileInitials.style.display = 'none';
  // set db logo
  dbLogo.innerHTML = '<img src="'+dataUrl+'" alt="logo">';
  localStorage.setItem('profileImage', dataUrl);
}
function setInitialsFromName(name){
  const parts = (name||'').trim().split(' ');
  let initials = 'PD';
  if(parts.length>0 && parts[0].length>0) initials = parts[0][0].toUpperCase() + (parts[1]? parts[1][0].toUpperCase() : '');
  profileInitials.innerText = initials;
}
function initProfile(){
  // load user or prompt (demo)
  let user = JSON.parse(localStorage.getItem('user') || 'null');
  if(!user || !user.name){
    const name = prompt('Enter your name to continue (demo login):') || 'Member';
    const password = prompt('Choose a password (demo):') || '';
    user = { name, password };
    localStorage.setItem('user', JSON.stringify(user));
  }
  document.getElementById('welcomeTitle').innerText = 'Welcome, ' + user.name;
  setInitialsFromName(user.name);
  // load profile image if available
  const savedImg = localStorage.getItem('profileImage');
  if(savedImg){ safeSetProfileImage(savedImg); }
}
initProfile();

/* ---------- Contribution modal behavior ---------- */
let preferredMethod = localStorage.getItem('preferredContribution') || 'bank';
function showBank(){ bankBlock.style.display='block'; usdtBlock.style.display='none'; preferredMethod='bank'; localStorage.setItem('preferredContribution','bank'); document.getElementById('bankBlock').style.display='block'; document.getElementById('usdtBlock').style.display='none'; document.getElementById('contribHint').innerText='Bank Deposit'; }
function showUSDT(){ bankBlock.style.display='none'; usdtBlock.style.display='block'; preferredMethod='usdt'; localStorage.setItem('preferredContribution','usdt'); document.getElementById('contribHint').innerText='USDT (TRC20)'; }
methodBankBtn.addEventListener('click', showBank);
methodUSDTBtn.addEventListener('click', showUSDT);

mContribute.addEventListener('click', ()=>{ closeMenu(); openModal(contributeModal); const pref = localStorage.getItem('preferredContribution') || 'bank'; if(pref==='usdt') showUSDT(); else showBank(); });

contribClose.addEventListener('click', ()=> closeModal(contributeModal));
contribCloseX.addEventListener('click', ()=> closeModal(contributeModal));

/* package selection */
packageSelect.addEventListener('change', ()=>{
  const val = packageSelect.value;
  if(!val){ packageAmount.innerText=''; projectName.innerText='No project selected'; projectMeta.innerText='Choose a package from Contribution'; localStorage.removeItem('selectedPackage'); return; }
  const pkg = JSON.parse(val);
  localStorage.setItem('selectedPackage', JSON.stringify(pkg));
  projectName.innerText = pkg.name + ' Package';
  projectMeta.innerText = pkg.name + ' • Package selected';
  packageAmount.innerText = '($' + pkg.price + ' Package)';
  progressTarget.innerText = 'Target: $' + pkg.price;
});

/* I have paid flow */
iPaidBtn.addEventListener('click', ()=>{
  proofArea.style.display='block';
  const pref = localStorage.getItem('preferredContribution') || preferredMethod || 'bank';
  if(pref === 'usdt'){ bankProofInputs.style.display='none'; usdtHashInput.style.display='block'; }
  else { bankProofInputs.style.display='flex'; usdtHashInput.style.display='none'; }
});
proofCloseX.addEventListener('click', ()=> proofArea.style.display='none');
cancelProof.addEventListener('click', ()=> proofArea.style.display='none');

/* preview proof */
previewProofBtn.addEventListener('click', ()=>{
  const f = proofFile.files[0];
  if(!f) return showToast('Choose a file first');
  filePreview.style.display='block';
  if(f.type.startsWith('image/')){
    const r = new FileReader();
    r.onload = e => filePreviewInner.innerHTML = '<img src="'+e.target.result+'" style="max-width:100%;border-radius:8px">';
    r.readAsDataURL(f);
  } else {
    filePreviewInner.innerHTML = '<div style="padding:8px;color:var(--muted)">'+f.name+'</div>';
  }
});
previewCloseX.addEventListener('click', ()=> { filePreview.style.display='none'; filePreviewInner.innerHTML=''; });

/* submit proof or tx hash (demo persist to localStorage) */
submitProof.addEventListener('click', ()=>{
  const pkg = JSON.parse(localStorage.getItem('selectedPackage') || 'null');
  if(!pkg) return showToast('Choose a package first');
  const pref = localStorage.getItem('preferredContribution') || preferredMethod || 'bank';
  const record = { id: 'PAY-'+Date.now(), package: pkg, method: pref, date: new Date().toISOString(), status: 'pending' };
  if(pref === 'usdt'){
    const hash = txHash.value && txHash.value.trim();
    if(!hash) return showToast('Paste transaction hash first');
    record.hash = hash;
  } else {
    const f = proofFile.files[0];
    if(!f) return showToast('Upload proof file first');
    record.proofFilename = f.name; // demo only
  }
  payments.push(record);
  localStorage.setItem('payments', JSON.stringify(payments));
  // show confirmation message inside modal
  const modal = contributeModal.querySelector('.modal');
  modal.innerHTML = '<button class="close-x" id="contribCloseConfirm">✕</button><h3>Congratulations (Pending Approval)</h3><p style="color:var(--muted)">Please be patient while we review your payment within 48 hours.</p><div style="margin-top:12px"><button class="btn" id="backToDashboard">Back to dashboard</button></div>';
  setTimeout(()=>{
    document.getElementById('backToDashboard').addEventListener('click', ()=>{
      location.reload(); // simple restore of UI state for demo
    });
    document.getElementById('contribCloseConfirm').addEventListener('click', ()=> location.reload());
  },80);
  // cleanup
  proofArea.style.display='none';
  filePreview.style.display='none';
  filePreviewInner.innerHTML='';
  proofFile.value='';
  txHash.value='';
  refreshPaymentsNav();
});

/* refresh payments nav: creates Unapproved/Approved items and ensures menu closes when they are clicked */
function refreshPaymentsNav(){
  payments = JSON.parse(localStorage.getItem('payments') || '[]');
  paymentsNavPlace.innerHTML = '';
  if(payments.length>0){
    const unCount = payments.filter(p=>p.status==='pending').length;
    const apCount = payments.filter(p=>p.status==='approved').length;
    const btnUn = document.createElement('button'); btnUn.className='menu-item'; btnUn.innerHTML='<span>Unapproved Payments</span><span class="hint">'+unCount+'</span>';
    btnUn.addEventListener('click', ()=> { closeMenu(); openPaymentsList('pending'); });
    const btnAp = document.createElement('button'); btnAp.className='menu-item'; btnAp.innerHTML='<span>Approved Payments</span><span class="hint">'+apCount+'</span>';
    btnAp.addEventListener('click', ()=> { closeMenu(); openPaymentsList('approved'); });
    paymentsNavPlace.appendChild(btnUn); paymentsNavPlace.appendChild(btnAp);
  }
}

/* open payments list modal */
function openPaymentsList(status){
  payments = JSON.parse(localStorage.getItem('payments') || '[]');
  paymentsListArea.innerHTML = '';
  const list = payments.filter(p=>p.status===status);
  if(list.length===0){ paymentsListArea.innerHTML = '<div style="color:var(--muted)">No payments '+status+'</div>'; openModal(paymentsModal); return; }
  list.forEach(p=>{
    const d = document.createElement('div'); d.style.padding='10px'; d.style.background='rgba(255,255,255,0.02)'; d.style.borderRadius='8px'; d.style.marginTop='8px';
    d.innerHTML = '<div style="font-weight:800">'+p.package.name+' • $'+p.package.price+'</div><div style="font-size:13px;color:var(--muted)">'+(p.method==='usdt'?'USDT':'Bank')+' • '+new Date(p.date).toLocaleString()+'</div>';
    if(p.status==='pending'){
      const stat = document.createElement('div'); stat.style.marginTop='8px'; stat.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:var(--danger);margin-right:8px"></span><span>Yet to be approved</span>';
      d.appendChild(stat);
      const simWrap = document.createElement('div'); simWrap.style.marginTop='8px';
      const approveBtn = document.createElement('button'); approveBtn.className='btn'; approveBtn.innerText='Simulate Approve (Demo)';
      approveBtn.addEventListener('click', ()=>{
        // mark approved and move to projects
        p.status='approved';
        payments = payments.map(x=> x.id===p.id? p : x);
        localStorage.setItem('payments', JSON.stringify(payments));
        projects.push({ id:'PRJ-'+Date.now(), name:p.package.name, amount:p.package.price, status:'Active' });
        localStorage.setItem('projects', JSON.stringify(projects));
        // update referral demo
        const refs = parseInt(localStorage.getItem('referrals')||'0',10) + 1;
        localStorage.setItem('referrals', refs.toString());
        refreshPaymentsNav(); renderProjects(); updateReferralsUI();
        showToast('Payment approved (demo).');
        openPaymentsList('approved');
      });
      simWrap.appendChild(approveBtn); d.appendChild(simWrap);
    } else {
      const stat = document.createElement('div'); stat.style.marginTop='8px'; stat.innerHTML = '<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:#34d399;box-shadow:0 0 6px rgba(52,211,153,0.35);margin-right:8px"></span><span>Approved and active</span>';
      d.appendChild(stat);
      const viewBtn = document.createElement('button'); viewBtn.className='btn ghost'; viewBtn.style.marginTop='8px'; viewBtn.innerText='View in Projects';
      viewBtn.addEventListener('click', ()=> { closeModal(paymentsModal); renderProjects(); openModal(projectsModal); });
      d.appendChild(viewBtn);
    }
    paymentsListArea.appendChild(d);
  });
  openModal(paymentsModal);
}

/* ---------- Projects ---------- */
function renderProjects(){
  projects = JSON.parse(localStorage.getItem('projects') || '[]');
  projectsList.innerHTML = '';
  if(!projects || projects.length===0){ projectsList.innerHTML = '<div style="color:var(--muted)">No projects yet.</div>'; document.getElementById('activeProjectsCount').innerText = 0; return; }
  projects.forEach(p=>{
    const div = document.createElement('div'); div.className='project-item'; div.style.marginTop='8px'; div.style.padding='10px'; div.style.background='rgba(255,255,255,0.02)'; div.innerHTML = '<div style="font-weight:800">'+p.name+'</div><div style="font-size:13px;color:var(--muted)">ID: '+p.id+' • $'+p.amount+' • '+p.status+'</div>';
    projectsList.appendChild(div);
  });
  document.getElementById('activeProjectsCount').innerText = projects.length;
}

/* ---------- Edit Profile upload ---------- */
let pendingImageData = null;
profileImageFile.addEventListener('change', ()=>{
  const f = profileImageFile.files[0];
  if(!f) return showToast('Choose an image');
  if(!f.type.startsWith('image/')) return showToast('Image required');
  const r = new FileReader();
  r.onload = e => {
    pendingImageData = e.target.result;
    profilePreview.innerHTML = '<img src="'+pendingImageData+'" style="width:100%;height:100%;object-fit:cover">';
  };
  r.readAsDataURL(f);
});
editCancel.addEventListener('click', ()=> { closeModal(editProfileModal); pendingImageData=null; profileImageFile.value=''; profilePreview.innerHTML='No image'; });
editCloseX.addEventListener('click', ()=> { closeModal(editProfileModal); pendingImageData=null; profileImageFile.value=''; profilePreview.innerHTML='No image'; });

saveProfileBtn.addEventListener('click', ()=>{
  const pwd = newPassword.value.trim();
  if(pendingImageData){
    // update profile img element only (do not replace profileMenu)
    profileImg.src = pendingImageData;
    profileImg.style.display = 'block';
    profileInitials.style.display = 'none';
    dbLogo.innerHTML = '<img src="'+pendingImageData+'" alt="logo">';
    localStorage.setItem('profileImage', pendingImageData);
    pendingImageData = null;
    profileImageFile.value = '';
    profilePreview.innerHTML = 'No image';
  }
  if(pwd){
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    user.password = pwd;
    localStorage.setItem('user', JSON.stringify(user));
    newPassword.value = '';
    showToast('Password saved (demo)');
  }
  showToast('Profile updated');
  closeModal(editProfileModal);
});

/* ---------- Copy buttons ---------- */
copyButtons.forEach(btn => btn.addEventListener('click', (e)=> {
  const key = e.currentTarget.getAttribute('data-copy');
  if(key === 'bankAcct') copyText(document.getElementById('bankAcct').innerText.trim());
  if(key === 'walletAddr') copyText(document.getElementById('walletAddr').innerText.trim());
}));

/* ---------- QR ---------- */
if(document.getElementById('showQR')){
  document.getElementById('showQR').addEventListener('click', ()=>{
    const addr = document.getElementById('walletAddr').innerText.trim();
    const src = 'https://chart.googleapis.com/chart?cht=qr&chs=300x300&chl=' + encodeURIComponent(addr);
    qrImage.innerHTML = '<img src="'+src+'" style="width:100%;height:100%;object-fit:cover">';
    closeModal(contributeModal); openModal(qrModal);
  });
}
qrClose.addEventListener('click', ()=> closeModal(qrModal));
qrCloseX.addEventListener('click', ()=> closeModal(qrModal));

/* ---------- Payments modal controls ---------- */
paymentsClose.addEventListener('click', ()=> closeModal(paymentsModal));
paymentsCloseX.addEventListener('click', ()=> closeModal(paymentsModal));

/* ---------- Projects modal controls ---------- */
projectsClose.addEventListener('click', ()=> closeModal(projectsModal));
document.getElementById('projectsCloseX').addEventListener('click', ()=> closeModal(projectsModal));

/* ---------- Logout ---------- */
btnNo.addEventListener('click', ()=> closeModal(logoutModal));
btnYes.addEventListener('click', ()=> {
  closeModal(logoutModal);
  // same logout animation behavior demo
  document.getElementById('appRoot').style.opacity = '0.25';
  setTimeout(()=> location.href = 'login.html', 900);
});
document.getElementById('mLogout').addEventListener('click', ()=> { closeMenu(); openModal(logoutModal); });

/* ---------- Sharing ---------- */
[shareHere].forEach(el => el.addEventListener('click', async ()=>{
  const url = location.href;
  const obj = { title:'Join me on Dream Big', text:'Sign up and start building with Dream Big', url };
  if(navigator.share){ try{ await navigator.share(obj); } catch(e){} } else if(navigator.clipboard){ navigator.clipboard.writeText(url).then(()=> showToast('Referral copied')); } else alert('Copy: '+url);
}));

/* ---------- Init state ---------- */
function updateReferralsUI(){
  const refs = parseInt(localStorage.getItem('referrals')||'0',10);
  document.getElementById('refersNum').innerText = refs;
}
function init(){
  const meta = document.getElementById('metaDate');
  if(!meta.innerText) { const d=new Date(); meta.innerText = (d.getMonth()+1)+'/'+d.getDate()+'/'+d.getFullYear(); }
  // load saved profile image
  const savedImg = localStorage.getItem('profileImage');
  if(savedImg){ profileImg.src = savedImg; profileImg.style.display='block'; profileInitials.style.display='none'; dbLogo.innerHTML = '<img src="'+savedImg+'">'; }
  // load selected package
  const pkg = JSON.parse(localStorage.getItem('selectedPackage') || 'null');
  if(pkg){ projectName.innerText = pkg.name + ' Package'; projectMeta.innerText = pkg.name + ' • Package selected'; packageAmount.innerText = '($' + pkg.price + ' Package)'; progressTarget.innerText = 'Target: $' + pkg.price; }
  // init payments nav
  refreshPaymentsNav();
  renderProjects();
  updateReferralsUI();
}
init();

</script>
</body>
</html>
