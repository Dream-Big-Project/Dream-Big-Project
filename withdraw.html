<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Withdraw — Dream Big Project</title>
<meta name="description" content="Withdraw request page (Demo)" />
<style>
  :root{
    --bg:#071735;
    --card:#0f2946;
    --muted:#9fb3c7;
    --accent:#f6c44b;
    --accent-contrast:#071735;
    --glass: rgba(255,255,255,0.03);
    --danger: #ff5b5b;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    color: #eaf6ff;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; margin:0; background: linear-gradient(180deg,#021226,#071735); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .wrap{ max-width:980px; margin:28px auto; padding:22px; display:grid; grid-template-columns: 1fr 420px; gap:22px; align-items:start; }
  .card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px; padding:18px; box-shadow: 0 30px 60px rgba(0,0,0,0.45); }
  h1{ margin:0 0 8px 0; font-size:20px; letter-spacing:-0.3px; }
  p.muted{ margin:6px 0 12px 0; color:var(--muted); font-size:14px; }
  .balance{ font-weight:900; font-size:28px; color:var(--accent); margin-top:6px; }
  .form-row{ display:flex; gap:8px; align-items:center; margin-top:12px; }
  input[type="number"], input[type="text"], select, textarea { width:100%; padding:10px 12px; border-radius:10px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); font-size:15px; }
  .btn{ padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:800; }
  .btn.primary{ background: linear-gradient(135deg,var(--accent), #f0c75e); color:var(--accent-contrast); }
  .btn.ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.06); }
  .left-block{ min-height:220px; }
  .small{ font-size:13px; color:var(--muted); margin-top:6px; }
  .account-head{ font-weight:800; margin-bottom:6px; }
  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
  .file-input{ color:var(--muted); font-size:13px; }
  .status-pill{ display:inline-block; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,0.04); color:var(--muted); font-weight:800; }
  .disabled{ opacity:0.45; pointer-events:none; }
  .muted-box{ background: rgba(255,255,255,0.02); padding:12px; border-radius:10px; color:var(--muted); font-size:14px; }
  .center{ text-align:center; }

  /* confirmation modal overlay */
  .modal-overlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 220;
    background: rgba(2,6,20,0.6);
  }
  .modal-card {
    width: 92%;
    max-width: 520px;
    background: var(--card);
    padding: 20px;
    border-radius: 12px;
    color: #eaf6ff;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
  }
  .modal-card h3 { margin:0 0 8px 0; color:var(--accent); font-size:18px; }
  .modal-row { display:flex; justify-content:space-between; align-items:center; margin-top:8px; }
  .modal-note { color:var(--muted); font-size:14px; margin-top:8px; }

  /* non-blocking submission modal (small card) */
  .submission-toast {
    position: fixed;
    right: 22px;
    bottom: 22px;
    min-width:260px;
    max-width:420px;
    z-index:140;
    display:none;
    pointer-events:auto;
  }
  .submission-toast .card { padding:12px; border-radius:10px; }

  /* toast for messages */
  .toast {
    position: fixed;
    left: 50%;
    transform: translateX(-50%) translateY(12px);
    bottom: 22px;
    z-index:260;
    padding: 10px 14px;
    border-radius: 10px;
    font-weight:800;
    color: #fff;
    display: inline-block;
    opacity: 0;
    pointer-events: none;
    transition: transform 300ms cubic-bezier(.2,.9,.2,1), opacity 300ms;
  }
  .toast.show { opacity:1; transform: translateX(-50%) translateY(0); pointer-events:auto; }
  .toast.hide { opacity:0; transform: translateX(-50%) translateY(12px); pointer-events:none; }

  .toast.info { background: rgba(0,0,0,0.8); }
  .toast.error { background: linear-gradient(180deg, var(--danger), #d94343); }

  /* pending preview element under left card (distinct look) */
  .pending-preview { background: rgba(255,255,255,0.02); padding:12px; border-radius:10px; color:var(--muted); font-size:14px; margin-top:12px; }

  /* subtle disabled style for specific controls */
  .control-disabled { opacity:0.55; pointer-events:none; }

  @media(max-width:980px){
    .wrap{ grid-template-columns: 1fr; padding:14px; gap:14px; }
    .submission-toast{ right: 12px; left: 12px; transform:none; }
  }

</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT: withdraw request -->
    <div class="card left-block" id="leftCard" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h1>Request a withdrawal</h1>
        <button id="backBtn" class="btn ghost" title="Back to dashboard">Back</button>
      </div>

      <p class="muted">Enter an amount to withdraw or request your full available balance. Requests are processed by admin and typically take up to 72 hours.</p>

      <div class="muted-box">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:12px;color:var(--muted)">Available balance</div>
            <div class="balance" id="balanceDisplay">$0</div>
          </div>
          <div class="status-pill" id="reqStatusPill" style="display:none">Processing</div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <label for="amount">Amount to withdraw</label>
        <input id="amount" type="number" step="0.01" min="1" placeholder="Enter amount (USD)" />
        <div class="form-row" style="margin-top:10px">
          <button class="btn primary" id="requestAll">Request withdraw all my balance</button>
          <button class="btn ghost" id="requestBtn">Request</button>
        </div>
        <div class="small">Tip: once requested the withdrawal will be marked pending — you cannot request another until admin completes this one.</div>
      </div>

    </div>

    <!-- RIGHT: account details -->
    <div class="card" id="rightCard">
      <h2 class="account-head">Account details</h2>
      <p class="muted">Save the account where you'd like funds sent. You can choose bank or TRC20 wallet.</p>

      <label for="methodSelect">Transfer method</label>
      <select id="methodSelect">
        <option value="bank">Bank transfer</option>
        <option value="trc20">USDT (TRC20)</option>
      </select>

      <!-- Bank fields -->
      <div id="bankFields" style="margin-top:12px;">
        <label for="bankName">Bank name</label>
        <input id="bankName" type="text" placeholder="e.g. First National Bank" />

        <label for="acctName" style="margin-top:8px">Account name</label>
        <input id="acctName" type="text" placeholder="Account holder's name" />

        <label for="acctNumber" style="margin-top:8px">Account number</label>
        <input id="acctNumber" type="text" placeholder="0123456789" />

        <label for="bankProof" style="margin-top:8px">Upload account proof (optional)</label>
        <input id="bankProof" class="file-input" type="file" accept="image/*,.pdf" />
      </div>

      <!-- TRC20 fields -->
      <div id="trcFields" class="hidden" style="margin-top:12px;">
        <label for="trcAddress">TRC20 wallet address</label>
        <input id="trcAddress" type="text" placeholder="T..." />
        <div class="small" style="margin-top:8px">Make sure this is a TRON / TRC20 compatible address.</div>
      </div>

      <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
        <button class="btn ghost" id="saveAccount">Save</button>
      </div>

      <div style="margin-top:14px;">
        <div id="savedAccountPreview" class="muted-box hidden"></div>
      </div>

      <!-- dev helpers visible for demo -->
      <div style="margin-top:16px;font-size:12px;color:var(--muted)" id="devTools">
        <button id="simulateApprove" class="btn ghost">Simulate admin approve (dev)</button>
        <button id="simulateReceive" class="btn ghost">Simulate received (dev)</button>
      </div>
    </div>
  </div>

  <!-- confirmation modal -->
  <div class="modal-overlay" id="confirmModal" role="dialog" aria-hidden="true" aria-labelledby="confirmTitle">
    <div class="modal-card" role="document">
      <h3 id="confirmTitle">Please take note</h3>
      <div class="modal-note">A <strong>10% withdrawal processing fee</strong> is applicable to all withdrawals. Below are the details for this request:</div>

      <div style="margin-top:12px;">
        <div class="modal-row"><div>Requested amount</div><div id="confAmount" style="font-weight:800"></div></div>
        <div class="modal-row" style="margin-top:8px"><div>Processing fee (10%)</div><div id="confFee" style="font-weight:800"></div></div>
        <div class="modal-row" style="margin-top:8px"><div>Net amount</div><div id="confNet" style="font-weight:900;color:var(--accent)"></div></div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px">
        <button class="btn ghost" id="confirmBackBtn">Back</button>
        <button class="btn primary" id="confirmContinueBtn">Continue</button>
      </div>
    </div>
  </div>

  <!-- non-blocking submission toast (small confirmation card) -->
  <div class="submission-toast" id="submissionToast" aria-hidden="true">
    <div class="card" id="submissionCard" style="background:var(--card); color:var(--muted);">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800; color:var(--accent)">Withdrawal submitted</div>
          <div id="submissionNote" style="font-size:13px; margin-top:6px">Your withdrawal is being processed and usually takes up to 72 hours.</div>
        </div>
        <div style="margin-left:12px;">
          <div class="status-pill" style="background: rgba(255,255,255,0.03); color:var(--muted);">Pending</div>
        </div>
      </div>
    </div>
  </div>

  <!-- toast placeholder -->
  <div id="toastContainer" aria-live="polite"></div>

<script>
(function(){
  // localStorage keys
  const balanceKey = 'balance';
  const requestKey = 'withdrawRequest';
  const accountKey = 'withdrawAccount';

  // elements
  const balanceDisplay = document.getElementById('balanceDisplay');
  const amountInput = document.getElementById('amount');
  const requestBtn = document.getElementById('requestBtn');
  const requestAllBtn = document.getElementById('requestAll');
  const methodSelect = document.getElementById('methodSelect');
  const bankFields = document.getElementById('bankFields');
  const trcFields = document.getElementById('trcFields');
  const saveAccountBtn = document.getElementById('saveAccount');
  const acctName = document.getElementById('acctName');
  const bankName = document.getElementById('bankName');
  const acctNumber = document.getElementById('acctNumber');
  const bankProof = document.getElementById('bankProof');
  const trcAddress = document.getElementById('trcAddress');
  const savedAccountPreview = document.getElementById('savedAccountPreview');
  const reqStatusPill = document.getElementById('reqStatusPill');
  const submissionToast = document.getElementById('submissionToast');
  const submissionNote = document.getElementById('submissionNote');
  const toastContainer = document.getElementById('toastContainer');
  const pendingPreviewId = 'pendingPreview';
  const simulateApprove = document.getElementById('simulateApprove');
  const simulateReceive = document.getElementById('simulateReceive');
  const backBtn = document.getElementById('backBtn');

  // confirmation modal elements
  const confirmModal = document.getElementById('confirmModal');
  const confAmount = document.getElementById('confAmount');
  const confFee = document.getElementById('confFee');
  const confNet = document.getElementById('confNet');
  const confirmContinueBtn = document.getElementById('confirmContinueBtn');
  const confirmBackBtn = document.getElementById('confirmBackBtn');

  /* ====== Helpers: localStorage management ====== */
  function getBalance(){
    const raw = localStorage.getItem(balanceKey);
    if(raw === null || raw === undefined) {
      localStorage.setItem(balanceKey, '25000'); // demo default balance
      return 25000;
    }
    const n = parseFloat(raw);
    return isNaN(n) ? 0 : n;
  }
  function setBalance(v){
    localStorage.setItem(balanceKey, String(Number(v)));
    renderBalance();
  }
  function renderBalance(){
    const b = getBalance();
    balanceDisplay.innerText = '$' + Number(b).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function getAccount(){
    const raw = localStorage.getItem(accountKey);
    if(!raw) return null;
    try{ return JSON.parse(raw); } catch(e){ return null; }
  }
  function saveAccount(obj){
    localStorage.setItem(accountKey, JSON.stringify(obj));
    renderSavedAccount();
  }
  function renderSavedAccount(){
    const acc = getAccount();
    if(!acc){ savedAccountPreview.classList.add('hidden'); savedAccountPreview.innerHTML = ''; return; }
    savedAccountPreview.classList.remove('hidden');
    let html = '<div style="font-weight:800;margin-bottom:6px">Saved account</div>';
    if(acc.method === 'bank'){
      html += '<div><strong>Bank:</strong> ' + escapeHtml(acc.bankName||'—') + '</div>';
      html += '<div><strong>Account name:</strong> ' + escapeHtml(acc.acctName||'—') + '</div>';
      html += '<div><strong>Account number:</strong> ' + escapeHtml(acc.acctNumber||'—') + '</div>';
      if(acc.proofName) html += '<div style="margin-top:6px;font-size:13px;color:var(--muted)"><em>Proof:</em> ' + escapeHtml(acc.proofName) + '</div>';
    } else {
      html += '<div><strong>TRC20 address:</strong></div><div style="word-break:break-all">' + escapeHtml(acc.trcAddress||'—') + '</div>';
    }
    savedAccountPreview.innerHTML = html;
  }

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function getRequest(){
    try{ return JSON.parse(localStorage.getItem(requestKey) || 'null'); } catch(e){ return null; }
  }
  function saveRequest(req){ localStorage.setItem(requestKey, JSON.stringify(req)); renderRequestState(); }
  function clearRequest(){ localStorage.removeItem(requestKey); renderRequestState(); }

  /* ====== Toasts & messages ====== */
  function showInfo(text, ms = 1400){
    showToast(text, 'info', ms);
  }
  function showError(text, ms = 3700){
    showToast(text, 'error', ms);
  }
  function showToast(text, type='info', ms=1400){
    const el = document.createElement('div');
    el.className = 'toast ' + (type === 'error' ? 'error' : 'info');
    el.innerText = text;
    toastContainer.appendChild(el);

    // force reflow to enable transition
    requestAnimationFrame(() => {
      el.classList.add('show');
    });

    // hide after ms
    setTimeout(() => {
      el.classList.remove('show');
      el.classList.add('hide');
      setTimeout(() => { el.remove(); }, 360);
    }, ms);
  }

  /* ====== Pending UI state toggles ====== */
  function setPendingControls(enabled){
    // enabled = true -> pending active (disable withdraw controls)
    if(enabled){
      // show pill and disable amount+request buttons
      reqStatusPill.style.display = 'inline-block';
      reqStatusPill.innerText = 'Processing';
      amountInput.classList.add('control-disabled');
      requestBtn.classList.add('control-disabled');
      requestAllBtn.classList.add('control-disabled');
      amountInput.value = '';
    } else {
      reqStatusPill.style.display = 'none';
      amountInput.classList.remove('control-disabled');
      requestBtn.classList.remove('control-disabled');
      requestAllBtn.classList.remove('control-disabled');
    }
  }

  function renderRequestState(){
    const req = getRequest();
    // remove any old preview
    const existing = document.getElementById(pendingPreviewId);
    if(existing) existing.remove();

    if(req && req.status === 'processing'){
      // show persistent pending preview under left card
      setPendingControls(true);
      const preview = document.createElement('div');
      preview.className = 'pending-preview';
      preview.id = pendingPreviewId;
      preview.innerHTML = '<div style="font-weight:800">Pending withdrawal</div>'
        + '<div style="margin-top:8px">Amount: $' + Number(req.amount).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>'
        + '<div style="margin-top:6px">Requested: ' + (new Date(req.date)).toLocaleString() + '</div>';
      document.getElementById('leftCard').appendChild(preview);

      // show non-blocking small submission toast
      submissionToast.style.display = 'block';
      submissionToast.setAttribute('aria-hidden','false');
      submissionNote.innerText = 'Your withdrawal is being processed and usually takes up to 72 hours.';
    } else if(req && req.status === 'approved'){
      // approved but not yet received: still block new withdraw until received
      setPendingControls(true);
      const preview = document.createElement('div');
      preview.className = 'pending-preview';
      preview.id = pendingPreviewId;
      preview.innerHTML = '<div style="font-weight:800">Withdrawal approved (awaiting receipt)</div>'
        + '<div style="margin-top:8px">Amount: $' + Number(req.amount).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>'
        + '<div style="margin-top:6px">Approved: ' + (req.approvedAt ? new Date(req.approvedAt).toLocaleString() : '—') + '</div>';
      document.getElementById('leftCard').appendChild(preview);

      submissionToast.style.display = 'block';
      submissionToast.setAttribute('aria-hidden','false');
      submissionNote.innerText = 'Your withdrawal was approved. Awaiting final receipt.';
    } else {
      // no pending or completed
      setPendingControls(false);
      submissionToast.style.display = 'none';
      submissionToast.setAttribute('aria-hidden','true');
    }
  }

  /* ====== UI wiring ====== */
  methodSelect.addEventListener('change', ()=>{
    const m = methodSelect.value;
    if(m === 'bank'){ bankFields.classList.remove('hidden'); trcFields.classList.add('hidden'); }
    else { bankFields.classList.add('hidden'); trcFields.classList.remove('hidden'); }
  });

  (function initAccountInputs(){
    const acc = getAccount();
    if(!acc) return;
    methodSelect.value = acc.method || 'bank';
    methodSelect.dispatchEvent(new Event('change'));
    if(acc.method === 'bank'){
      bankName.value = acc.bankName || '';
      acctName.value = acc.acctName || '';
      acctNumber.value = acc.acctNumber || '';
    } else {
      trcAddress.value = acc.trcAddress || '';
    }
    renderSavedAccount();
  })();

  saveAccountBtn.addEventListener('click', ()=>{
    const method = methodSelect.value;
    if(method === 'bank'){
      const bn = bankName.value.trim();
      const an = acctName.value.trim();
      const num = acctNumber.value.trim();
      if(!bn || !an || !num) { showError('Please fill bank name, account name and account number.'); return; }
      const proofFile = bankProof.files[0];
      const obj = { method: 'bank', bankName: bn, acctName: an, acctNumber: num };
      if(proofFile) obj.proofName = proofFile.name;
      saveAccount(obj);
      showInfo('Account saved.');
    } else {
      const addr = trcAddress.value.trim();
      if(!addr) { showError('Please paste your TRC20 address.'); return; }
      saveAccount({ method: 'trc20', trcAddress: addr });
      showInfo('TRC20 address saved.');
    }
  });

  requestAllBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const b = getBalance();
    if(b <= 0) { showError('No available balance to withdraw.'); return; }
    amountInput.value = Number(b).toFixed(2);
  });

  // When request button clicked, show confirmation modal first (if validations pass)
  requestBtn.addEventListener('click', (e)=>{
    e.preventDefault();

    const existing = getRequest();
    if(existing && (existing.status === 'processing' || existing.status === 'approved')) {
      // cannot place another request while existing pending/approved
      showInfo('You already have a pending withdrawal. You cannot create another until this one completes.');
      return;
    }

    const amount = parseFloat(amountInput.value);
    if(isNaN(amount) || amount <= 0){ showError('Enter a valid amount.'); return; }

    const balance = getBalance();
    if(amount > balance){
      // insufficient
      showError('Insufficient balance');
      return;
    }

    // prepare modal values: show amount, fee (10%), net
    const fee = Math.round((amount * 0.10 + Number.EPSILON) * 100) / 100;
    const net = Math.round((amount - fee + Number.EPSILON) * 100) / 100;

    confAmount.innerText = '$' + amount.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    confFee.innerText = '$' + fee.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    confNet.innerText = '$' + net.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

    // store these temporarily on the confirmContinueBtn dataset so Continue can access them
    confirmContinueBtn.dataset.amount = String(amount);
    confirmContinueBtn.dataset.fee = String(fee);
    confirmContinueBtn.dataset.net = String(net);

    // show modal
    openConfirmModal();
  });

  // Confirm modal actions
  function openConfirmModal(){
    confirmModal.style.display = 'flex';
    confirmModal.setAttribute('aria-hidden','false');
  }
  function closeConfirmModal(){
    confirmModal.style.display = 'none';
    confirmModal.setAttribute('aria-hidden','true');
    // clear dataset (defensive)
    confirmContinueBtn.dataset.amount = '';
    confirmContinueBtn.dataset.fee = '';
    confirmContinueBtn.dataset.net = '';
  }

  confirmBackBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    // close modal and do nothing (balance untouched)
    closeConfirmModal();
  });

  // When user confirms, complete the withdrawal creation (same logic as previously)
  confirmContinueBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    const amt = parseFloat(confirmContinueBtn.dataset.amount);
    if(isNaN(amt) || amt <= 0){ showError('Invalid amount.'); closeConfirmModal(); return; }

    // hide modal before proceeding
    closeConfirmModal();

    // account presence check (non-blocking)
    const acc = getAccount();
    if(!acc) {
      if(!confirm('No account saved. Admin may not know where to send funds. Continue anyway?')) return;
    }

    const balance = getBalance();
    // final re-check balance just before committing (defensive)
    if(amt > balance){ showError('Insufficient balance'); return; }

    // create request and save
    const req = {
      id: 'WD-' + Date.now(),
      amount: Number(amt),
      date: new Date().toISOString(),
      status: 'processing',
      account: acc || null,
      note: 'User requested withdrawal (10% fee will apply)'
    };

    // subtract balance immediately (pending)
    saveRequest(req);
    setBalance(Math.max(0, (balance - amt)));

    // show a quick non-blocking message + persistent pending preview
    showInfo('Withdrawal submitted. Processing by admin...');
    renderRequestState();
  });

  // dev buttons to simulate admin flows
  simulateApprove?.addEventListener('click', ()=>{
    const req = getRequest();
    if(!req) { showInfo('No request to approve.'); return; }
    req.status = 'approved';
    req.approvedAt = new Date().toISOString();
    saveRequest(req);
    showInfo('Request marked approved (demo).');
    renderRequestState();
  });

  simulateReceive?.addEventListener('click', ()=>{
    const req = getRequest();
    if(!req) { showInfo('No request to complete.'); return; }
    // mark as received/completed and clear request (for demo)
    req.status = 'received';
    req.receivedAt = new Date().toISOString();
    // We'll remove the request and show final success message.
    clearRequest();
    showInfo('Withdrawal received. You can make a new request.');
  });

  // Back button wiring: navigate to dashboard.html
  backBtn.addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = 'dashboard.html';
  });

  // initial render
  renderBalance();
  renderSavedAccount();
  renderRequestState();

  // Accessibility: pressing Enter on amount triggers request
  amountInput.addEventListener('keydown', (ev) => {
    if(ev.key === 'Enter') {
      ev.preventDefault();
      requestBtn.click();
    }
  });

})();
</script>
</body>
</html>



